<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Organizer Deluxe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        .drink-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .drink-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.75);
        }
        .category-active {
            background-color: #4a5fa5 !important; /* A distinct color for active category */
            color: white !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans leading-normal tracking-normal">

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, child, remove, push, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // User-provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAVEM6X3OEUuCDBrpShe02Rnq8p13oEf4s",
            authDomain: "bar-organizer-f3784.firebaseapp.com",
            databaseURL: "https://bar-organizer-f3784-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bar-organizer-f3784",
            storageBucket: "bar-organizer-f3784.firebasestorage.app",
            messagingSenderId: "908059088110",
            appId: "1:908059088110:web:03b861013c137ef1e2cfff",
            measurementId: "G-M99V8FNP35"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database);

        // --- Global State ---
        let allCategories = {};
        let allDrinks = {};
        let currentFilterType = "Alles"; // Mocktail, Cocktail, Alles
        let currentSearchQuery = "";
        let selectedCategoryId = null;
        let editModeActive = false;
        const UNCATEGORIZED_ID = "uncategorized";
        const UNCATEGORIZED_NAME = "Unkategorisiert";

        // --- UI Elements ---
        const categoriesContainer = document.getElementById('categoriesContainer');
        const drinksContainer = document.getElementById('drinksContainer');
        const searchInput = document.getElementById('searchInput');
        const editModeButton = document.getElementById('editModeButton');
        const editModeStatus = document.getElementById('editModeStatus');
        const addCategoryButton = document.getElementById('addCategoryButton');
        const addDrinkButton = document.getElementById('addDrinkButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noDrinksMessage = document.getElementById('noDrinksMessage');
        const categoryTitle = document.getElementById('categoryTitle');

        // --- Modals ---
        const accessKeyModal = document.getElementById('accessKeyModal');
        const accessKeyInput = document.getElementById('accessKeyInput');
        const accessKeyError = document.getElementById('accessKeyError');

        const drinkModal = document.getElementById('drinkModal');
        const drinkForm = document.getElementById('drinkForm');
        const drinkModalTitle = document.getElementById('drinkModalTitle');
        const drinkIdInput = document.getElementById('drinkId');
        const drinkCategorySelect = document.getElementById('drinkCategory');

        const categoryModal = document.getElementById('categoryModal');
        const categoryForm = document.getElementById('categoryForm');
        const categoryModalTitle = document.getElementById('categoryModalTitle');
        const categoryIdInput = document.getElementById('categoryId');

        const confirmModal = document.getElementById('confirmModal');
        const confirmModalText = document.getElementById('confirmModalText');
        let confirmCallback = null;


        // --- Initial Data Setup (if database is empty) ---
        async function initializeDefaultData() {
            const snapshot = await get(child(dbRef, 'barOrganizerData/Key'));
            if (!snapshot.exists()) {
                console.log("Datenbank scheint leer zu sein. Initialisiere Standarddaten...");
                const defaultData = {
                    Key: "geheim123", // Default access key
                    categories: {
                        [UNCATEGORIZED_ID]: { name: UNCATEGORIZED_NAME },
                        "cat_mocktails": { name: "Mocktails" },
                        "cat_cocktails": { name: "Cocktails" }
                    },
                    drinks: { // Add a few sample drinks
                        "drink_pussycat": {
                            name: "Pussy Cat", type: "Mocktail", categoryId: "cat_mocktails",
                            ingredients: [{ item: "Cassissirup", amount: "2 cl" }, { item: "Ananassaft", amount: "6 cl" }, { item: "Orangensaft", amount: "6 cl" }, { item: "Grapefruitsaft", amount: "6 cl" }],
                            recipe: "Mit Eisw√ºrfeln im Shaker gut sch√ºtteln, in ein gro√ües Longdrinkglas auf einige Eisw√ºrfel abgie√üen und mit Fr√ºchten garnieren. Trinkhalm dazugeben.", symbols: "üçπ"
                        },
                        "drink_tropical": {
                            name: "Tropical", type: "Mocktail", categoryId: "cat_mocktails",
                            ingredients: [{ item: "Mandelsirup", amount: "2 cl" }, { item: "Pfefferminzsirup", amount: "2 cl" }, { item: "Milch", amount: "nach Bedarf" }],
                            recipe: "Mandelsirup und Pfefferminzsirup in ein Longdrinkglas geben und mit kalter Milch auff√ºllen.", symbols: "ü•õ"
                        },
                         "drink_mojito": {
                            name: "Mojito", type: "Cocktail", categoryId: "cat_cocktails",
                            ingredients: [{ item: "Wei√üer Rum", amount: "5 cl" }, { item: "Limettensaft", amount: "2.5 cl" }, { item: "Zuckersirup", amount: "2 cl" }, { item: "Minzbl√§tter", amount: "8-10" }, {item: "Sodawasser", amount: "Auff√ºllen"}],
                            recipe: "Minzbl√§tter mit Zucker und Limettensaft im Glas leicht andr√ºcken. Glas mit Crushed Ice f√ºllen, Rum dazugeben und mit Sodawasser auff√ºllen. Vorsichtig umr√ºhren.", symbols: "üåø"
                        }
                    }
                };
                await set(child(dbRef, 'barOrganizerData'), defaultData);
                console.log("Standarddaten initialisiert.");
            }
        }


        // --- Firebase Data Listeners ---
        function loadData() {
            loadingIndicator.classList.remove('hidden');
            onValue(child(dbRef, 'barOrganizerData/categories'), (snapshot) => {
                allCategories = snapshot.val() || {};
                if (!allCategories[UNCATEGORIZED_ID]) { // Ensure uncategorized always exists
                    allCategories[UNCATEGORIZED_ID] = { name: UNCATEGORIZED_NAME };
                    // Optionally save it back to DB if it's critical to persist
                    // set(child(dbRef, `barOrganizerData/categories/${UNCATEGORIZED_ID}`), { name: UNCATEGORIZED_NAME });
                }
                renderCategories();
                populateCategorySelect(); // For drink form
                // If no category is selected, select the first one (or uncategorized)
                if (!selectedCategoryId || !allCategories[selectedCategoryId]) {
                    selectedCategoryId = Object.keys(allCategories)[0] || UNCATEGORIZED_ID;
                }
                filterAndRenderDrinks();
                loadingIndicator.classList.add('hidden');
            });

            onValue(child(dbRef, 'barOrganizerData/drinks'), (snapshot) => {
                allDrinks = snapshot.val() || {};
                filterAndRenderDrinks();
                loadingIndicator.classList.add('hidden');
            });
        }

        // --- Rendering Functions ---
        function renderCategories() {
            categoriesContainer.innerHTML = '';
            if (Object.keys(allCategories).length === 0) {
                 const defaultCat = { name: UNCATEGORIZED_NAME };
                 allCategories[UNCATEGORIZED_ID] = defaultCat;
                 set(child(dbRef, `barOrganizerData/categories/${UNCATEGORIZED_ID}`), defaultCat); // Persist if it wasn't there
            }


            Object.entries(allCategories).forEach(([id, category]) => {
                const isActive = id === selectedCategoryId;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `p-3 mb-2 rounded-lg cursor-pointer hover:bg-indigo-700 transition-colors duration-150 ease-in-out flex justify-between items-center ${isActive ? 'bg-indigo-600 category-active' : 'bg-gray-700'}`;
                categoryDiv.innerHTML = `
                    <span class="font-semibold">${category.name}</span>
                    ${editModeActive && id !== UNCATEGORIZED_ID ? `
                        <div class="space-x-2">
                            <button data-id="${id}" class="edit-category-btn text-yellow-400 hover:text-yellow-300"><i class="fas fa-edit"></i></button>
                            ${Object.keys(allCategories).length > 1 ? `<button data-id="${id}" class="delete-category-btn text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    ` : ''}
                     ${editModeActive && id === UNCATEGORIZED_ID && Object.keys(allCategories).length <=1 ? `
                        <div class="space-x-2">
                            <button data-id="${id}" class="edit-category-btn text-yellow-400 hover:text-yellow-300"><i class="fas fa-edit"></i></button>
                        </div>
                    ` : ''}
                `;
                categoryDiv.addEventListener('click', (e) => {
                    if (e.target.closest('.edit-category-btn') || e.target.closest('.delete-category-btn')) return;
                    selectedCategoryId = id;
                    renderCategories(); // Re-render to update active state
                    filterAndRenderDrinks();
                });
                categoriesContainer.appendChild(categoryDiv);
            });

            // Add event listeners for edit/delete category buttons
            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.addEventListener('click', () => handleEditCategory(btn.dataset.id));
            });
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', () => handleDeleteCategory(btn.dataset.id));
            });
        }

        function filterAndRenderDrinks() {
            if (!selectedCategoryId && Object.keys(allCategories).length > 0) {
                selectedCategoryId = Object.keys(allCategories)[0]; // Select first category if none selected
            } else if (Object.keys(allCategories).length === 0) {
                 selectedCategoryId = UNCATEGORIZED_ID; // Fallback if no categories exist
            }


            const currentCategoryName = allCategories[selectedCategoryId]?.name || "Alle Drinks";
            categoryTitle.textContent = currentCategoryName;
            drinksContainer.innerHTML = '';
            noDrinksMessage.classList.add('hidden');

            const drinksToDisplay = Object.entries(allDrinks).filter(([id, drink]) => {
                const matchesCategory = drink.categoryId === selectedCategoryId || (selectedCategoryId === 'all' && currentFilterType === 'Alles'); // 'all' could be a virtual category for "show all"
                const matchesType = currentFilterType === "Alles" || drink.type === currentFilterType;
                const nameMatch = drink.name.toLowerCase().includes(currentSearchQuery);
                const ingredients = drink.ingredients || [];
                const ingredientMatch = currentSearchQuery === "" || ingredients.some(ing => ing.item.toLowerCase().includes(currentSearchQuery));

                // If category is selected, filter by it. Otherwise (e.g. "All" types), don't filter by category strictly unless it's part of the search.
                let categoryCondition = true;
                if (selectedCategoryId && selectedCategoryId !== 'all') {
                    categoryCondition = drink.categoryId === selectedCategoryId;
                    if (!allCategories[drink.categoryId] && drink.categoryId !== UNCATEGORIZED_ID) { // Handle drinks with orphaned category ID
                         categoryCondition = selectedCategoryId === UNCATEGORIZED_ID; // Show in uncategorized
                    }
                }


                return categoryCondition && matchesType && (nameMatch || ingredientMatch);
            });

            if (drinksToDisplay.length === 0) {
                noDrinksMessage.classList.remove('hidden');
                noDrinksMessage.textContent = `Keine Drinks in "${currentCategoryName}" gefunden${currentSearchQuery ? ` f√ºr "${currentSearchQuery}"` : ''}.`;
                if (editModeActive && selectedCategoryId && selectedCategoryId !== 'all') {
                    addDrinkButton.classList.remove('hidden');
                } else {
                    addDrinkButton.classList.add('hidden');
                }
                return;
            }


            drinksToDisplay.forEach(([id, drink]) => {
                const drinkCard = document.createElement('div');
                drinkCard.className = 'bg-gray-800 p-6 rounded-xl shadow-lg drink-card';
                drinkCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-2xl font-bold text-indigo-400">${drink.name} <span class="text-lg">${drink.symbols || ''}</span></h3>
                        <span class="text-sm px-3 py-1 rounded-full ${drink.type === 'Mocktail' ? 'bg-green-600' : 'bg-red-600'}">${drink.type}</span>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold text-indigo-300 mb-1">Zutaten:</h4>
                        <ul class="list-disc list-inside text-gray-300 space-y-1">
                            ${(drink.ingredients || []).map(ing => `<li>${ing.amount} ${ing.item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold text-indigo-300 mb-1">Rezept:</h4>
                        <p class="text-gray-400 text-sm">${drink.recipe}</p>
                    </div>
                    ${editModeActive ? `
                        <div class="mt-4 pt-4 border-t border-gray-700 flex justify-end space-x-3">
                            <button data-id="${id}" class="edit-drink-btn text-yellow-400 hover:text-yellow-300 px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors"><i class="fas fa-edit mr-1"></i> Bearbeiten</button>
                            <button data-id="${id}" class="delete-drink-btn text-red-400 hover:text-red-300 px-3 py-1 rounded-md bg-gray-700 hover:bg-gray-600 transition-colors"><i class="fas fa-trash mr-1"></i> L√∂schen</button>
                        </div>
                    ` : ''}
                `;
                drinksContainer.appendChild(drinkCard);
            });

            // Add event listeners for edit/delete drink buttons
            document.querySelectorAll('.edit-drink-btn').forEach(btn => {
                btn.addEventListener('click', () => handleEditDrink(btn.dataset.id));
            });
            document.querySelectorAll('.delete-drink-btn').forEach(btn => {
                btn.addEventListener('click', () => handleDeleteDrink(btn.dataset.id));
            });

            if (editModeActive && selectedCategoryId && selectedCategoryId !== 'all') {
                 addDrinkButton.classList.remove('hidden');
            } else {
                 addDrinkButton.classList.add('hidden');
            }
        }


        // --- Edit Mode ---
        editModeButton.addEventListener('click', () => {
            if (editModeActive) {
                // Exit edit mode
                editModeActive = false;
                updateEditModeUI();
            } else {
                // Show access key modal
                accessKeyInput.value = '';
                accessKeyError.textContent = '';
                accessKeyModal.classList.remove('hidden');
            }
        });

        document.getElementById('accessKeySubmit').addEventListener('click', async () => {
            const keyAttempt = accessKeyInput.value;
            const dbKeySnapshot = await get(child(dbRef, 'barOrganizerData/Key'));
            const correctKey = dbKeySnapshot.val();

            if (keyAttempt === correctKey) {
                editModeActive = true;
                updateEditModeUI();
                accessKeyModal.classList.add('hidden');
            } else {
                accessKeyError.textContent = 'Ung√ºltiger Schl√ºssel.';
            }
        });
        document.getElementById('accessKeyCancel').addEventListener('click', () => accessKeyModal.classList.add('hidden'));


        function updateEditModeUI() {
            if (editModeActive) {
                editModeButton.innerHTML = '<i class="fas fa-lock-open mr-2"></i> Bearbeitungsmodus Verlassen';
                editModeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                editModeButton.classList.add('bg-red-500', 'hover:bg-red-600');
                editModeStatus.textContent = 'Bearbeitungsmodus Aktiv';
                editModeStatus.classList.remove('bg-gray-600');
                editModeStatus.classList.add('bg-yellow-500', 'text-gray-900');
                addCategoryButton.classList.remove('hidden');
                if (selectedCategoryId && selectedCategoryId !== 'all') addDrinkButton.classList.remove('hidden');

            } else {
                editModeButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Bearbeitungsmodus';
                editModeButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                editModeButton.classList.add('bg-green-500', 'hover:bg-green-600');
                editModeStatus.textContent = 'Ansichtsmodus';
                editModeStatus.classList.remove('bg-yellow-500', 'text-gray-900');
                editModeStatus.classList.add('bg-gray-600');
                addCategoryButton.classList.add('hidden');
                addDrinkButton.classList.add('hidden');
            }
            renderCategories(); // Re-render to show/hide edit buttons
            filterAndRenderDrinks(); // Re-render to show/hide edit buttons
        }

        // --- Search and Filter ---
        searchInput.addEventListener('input', (e) => {
            currentSearchQuery = e.target.value.toLowerCase();
            filterAndRenderDrinks();
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-indigo-700', 'ring-2', 'ring-indigo-400'));
                btn.classList.add('bg-indigo-700', 'ring-2', 'ring-indigo-400');
                currentFilterType = btn.dataset.type;
                filterAndRenderDrinks();
            });
        });

        // --- Category CRUD ---
        addCategoryButton.addEventListener('click', () => openCategoryModal());

        function openCategoryModal(id = null) {
            categoryForm.reset();
            categoryIdInput.value = id || '';
            if (id && allCategories[id]) {
                categoryModalTitle.textContent = 'Kategorie Bearbeiten';
                document.getElementById('categoryName').value = allCategories[id].name;
            } else {
                categoryModalTitle.textContent = 'Neue Kategorie Erstellen';
            }
            categoryModal.classList.remove('hidden');
        }

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = categoryIdInput.value;
            const name = document.getElementById('categoryName').value.trim();
            if (!name) {
                alert("Kategoriename darf nicht leer sein."); // Replace with custom modal later
                return;
            }

            const categoryData = { name };
            try {
                if (id) { // Update existing
                    await update(child(dbRef, `barOrganizerData/categories/${id}`), categoryData);
                } else { // Create new
                    const newCategoryRef = push(child(dbRef, 'barOrganizerData/categories'));
                    await set(newCategoryRef, categoryData);
                }
                categoryModal.classList.add('hidden');
                // Data will refresh via onValue listener
            } catch (error) {
                console.error("Fehler beim Speichern der Kategorie:", error);
                alert("Fehler beim Speichern der Kategorie."); // Replace
            }
        });
        document.getElementById('categoryCancel').addEventListener('click', () => categoryModal.classList.add('hidden'));

        function handleEditCategory(id) {
            openCategoryModal(id);
        }

        async function handleDeleteCategory(id) {
            if (id === UNCATEGORIZED_ID) {
                showCustomAlert("Die 'Unkategorisiert' Kategorie kann nicht gel√∂scht werden.");
                return;
            }
            if (Object.keys(allCategories).length <= 1) {
                showCustomAlert("Die letzte Kategorie kann nicht gel√∂scht werden.");
                return;
            }

            showConfirmModal(`Sicher, dass du die Kategorie "${allCategories[id].name}" l√∂schen willst? Alle Drinks darin werden als "Unkategorisiert" markiert.`, async () => {
                try {
                    // Move drinks to uncategorized
                    const updates = {};
                    Object.entries(allDrinks).forEach(([drinkId, drink]) => {
                        if (drink.categoryId === id) {
                            updates[`barOrganizerData/drinks/${drinkId}/categoryId`] = UNCATEGORIZED_ID;
                        }
                    });
                    await update(dbRef, updates); // Perform all drink updates

                    // Delete category
                    await remove(child(dbRef, `barOrganizerData/categories/${id}`));

                    if (selectedCategoryId === id) {
                        selectedCategoryId = UNCATEGORIZED_ID; // Fallback to uncategorized
                    }
                    // Data will refresh via onValue, which will re-render
                } catch (error) {
                    console.error("Fehler beim L√∂schen der Kategorie:", error);
                    showCustomAlert("Fehler beim L√∂schen der Kategorie.");
                }
            });
        }


        // --- Drink CRUD ---
        addDrinkButton.addEventListener('click', () => {
            if (selectedCategoryId && selectedCategoryId !== 'all') {
                openDrinkModal(null, selectedCategoryId);
            } else {
                showCustomAlert("Bitte w√§hle zuerst eine Kategorie aus der Liste links aus, um einen Drink hinzuzuf√ºgen.");
            }
        });


        function populateCategorySelect(selectedDrinkCategoryId = null) {
            drinkCategorySelect.innerHTML = '';
            Object.entries(allCategories).forEach(([id, category]) => {
                if (id === UNCATEGORIZED_ID && (!selectedDrinkCategoryId || selectedDrinkCategoryId !== UNCATEGORIZED_ID)) return; // Don't offer 'Uncategorized' unless editing a drink already in it
                const option = document.createElement('option');
                option.value = id;
                option.textContent = category.name;
                if (selectedDrinkCategoryId === id) {
                    option.selected = true;
                }
                drinkCategorySelect.appendChild(option);
            });
             // If no category selected (e.g. new drink and current category is 'all'), select the current one
            if (!selectedDrinkCategoryId && selectedCategoryId && allCategories[selectedCategoryId] && selectedCategoryId !== 'all') {
                 drinkCategorySelect.value = selectedCategoryId;
            } else if (!selectedDrinkCategoryId && Object.keys(allCategories).length > 0) {
                // Fallback to the first available category if nothing else makes sense
                const firstValidCategory = Object.keys(allCategories).find(catId => catId !== UNCATEGORIZED_ID) || Object.keys(allCategories)[0];
                if(firstValidCategory) drinkCategorySelect.value = firstValidCategory;
            }
        }


        function openDrinkModal(id = null, currentCatId = null) {
            drinkForm.reset();
            document.getElementById('ingredientsContainer').innerHTML = ''; // Clear previous ingredients
            addIngredientField(); // Add one initial ingredient field

            drinkIdInput.value = id || '';

            let drinkCategoryIdForSelect = currentCatId || selectedCategoryId;


            if (id && allDrinks[id]) {
                drinkModalTitle.textContent = 'Drink Bearbeiten';
                const drink = allDrinks[id];
                document.getElementById('drinkName').value = drink.name;
                document.getElementById('drinkType').value = drink.type;
                document.getElementById('drinkSymbols').value = drink.symbols || '';
                document.getElementById('drinkRecipe').value = drink.recipe;
                drinkCategoryIdForSelect = drink.categoryId; // Use the drink's actual category for the select

                if (drink.ingredients && drink.ingredients.length > 0) {
                    document.getElementById('ingredientsContainer').innerHTML = ''; // Clear initial blank field
                    drink.ingredients.forEach(ing => addIngredientField(ing.item, ing.amount));
                }
            } else {
                drinkModalTitle.textContent = 'Neuen Drink Erstellen';
                 // For new drinks, pre-select the currently active category if it's not 'all'
                if (selectedCategoryId && selectedCategoryId !== 'all' && allCategories[selectedCategoryId]) {
                    drinkCategoryIdForSelect = selectedCategoryId;
                } else if (Object.keys(allCategories).length > 0) {
                    // If 'all' is selected or no category, pick the first non-uncategorized one
                    drinkCategoryIdForSelect = Object.keys(allCategories).find(catId => catId !== UNCATEGORIZED_ID) || Object.keys(allCategories)[0];
                }
            }
            populateCategorySelect(drinkCategoryIdForSelect);
            drinkModal.classList.remove('hidden');
        }

        drinkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = drinkIdInput.value;
            const name = document.getElementById('drinkName').value.trim();
            const type = document.getElementById('drinkType').value;
            const categoryId = drinkCategorySelect.value;
            const symbols = document.getElementById('drinkSymbols').value.trim();
            const recipe = document.getElementById('drinkRecipe').value.trim();

            if (!name || !type || !categoryId || !recipe) {
                showCustomAlert("Bitte f√ºlle alle Pflichtfelder aus (Name, Typ, Kategorie, Rezept).");
                return;
            }

            const ingredients = [];
            document.querySelectorAll('.ingredient-field').forEach(field => {
                const item = field.querySelector('input[name="ingredientItem"]').value.trim();
                const amount = field.querySelector('input[name="ingredientAmount"]').value.trim();
                if (item && amount) {
                    ingredients.push({ item, amount });
                }
            });

            if (ingredients.length === 0) {
                showCustomAlert("Bitte f√ºge mindestens eine Zutat hinzu.");
                return;
            }

            const drinkData = { name, type, categoryId, symbols, recipe, ingredients };

            try {
                if (id) { // Update existing
                    await update(child(dbRef, `barOrganizerData/drinks/${id}`), drinkData);
                } else { // Create new
                    const newDrinkRef = push(child(dbRef, 'barOrganizerData/drinks'));
                    await set(newDrinkRef, drinkData);
                }
                drinkModal.classList.add('hidden');
                // Data will refresh via onValue listener
            } catch (error) {
                console.error("Fehler beim Speichern des Drinks:", error);
                showCustomAlert("Fehler beim Speichern des Drinks.");
            }
        });

        document.getElementById('drinkCancel').addEventListener('click', () => drinkModal.classList.add('hidden'));
        document.getElementById('addIngredientBtn').addEventListener('click', () => addIngredientField());

        function addIngredientField(item = '', amount = '') {
            const ingredientsContainer = document.getElementById('ingredientsContainer');
            const newField = document.createElement('div');
            newField.className = 'ingredient-field flex space-x-2 mb-2 items-center';
            newField.innerHTML = `
                <input type="text" name="ingredientItem" placeholder="Zutat" value="${item}" class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                <input type="text" name="ingredientAmount" placeholder="Menge" value="${amount}" class="w-1/3 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                <button type="button" class="remove-ingredient-btn text-red-500 hover:text-red-400 p-2 rounded-md bg-gray-600 hover:bg-gray-500"><i class="fas fa-minus-circle"></i></button>
            `;
            ingredientsContainer.appendChild(newField);
            newField.querySelector('.remove-ingredient-btn').addEventListener('click', () => newField.remove());
        }


        function handleEditDrink(id) {
            openDrinkModal(id);
        }

        async function handleDeleteDrink(id) {
            showConfirmModal(`Sicher, dass du den Drink "${allDrinks[id].name}" l√∂schen willst?`, async () => {
                try {
                    await remove(child(dbRef, `barOrganizerData/drinks/${id}`));
                    // Data will refresh via onValue listener
                } catch (error) {
                    console.error("Fehler beim L√∂schen des Drinks:", error);
                    showCustomAlert("Fehler beim L√∂schen des Drinks.");
                }
            });
        }

        // --- Confirm Modal ---
        function showConfirmModal(text, callback) {
            confirmModalText.textContent = text;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }
        document.getElementById('confirmYes').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
        });
        document.getElementById('confirmNo').addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });

        // --- Custom Alert Modal (Simple Version) ---
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertText = document.getElementById('customAlertText');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        function showCustomAlert(message) {
            customAlertText.textContent = message;
            customAlertModal.classList.remove('hidden');
        }
        customAlertCloseBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
        });


        // --- Initial Load ---
        async function main() {
            await initializeDefaultData(); // Check and set up default data if DB is empty
            loadData();
            updateEditModeUI(); // Set initial UI state for edit mode
            // Set default filter button active
            document.querySelector('.filter-btn[data-type="Alles"]').classList.add('bg-indigo-700', 'ring-2', 'ring-indigo-400');
        }

        main();

    </script>

    <div class="min-h-screen flex flex-col md:flex-row">
        <aside class="w-full md:w-1/4 bg-gray-800 p-6 space-y-4 shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-indigo-400">Kategorien</h2>
                <button id="addCategoryButton" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                    <i class="fas fa-plus mr-1"></i> Neu
                </button>
            </div>
            <div id="categoriesContainer" class="space-y-2 max-h-[calc(100vh-200px)] overflow-y-auto pr-2">
                </div>
        </aside>

        <main class="w-full md:w-3/4 p-6 md:p-10 bg-gray-900">
            <header class="mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 mb-4 sm:mb-0">
                        Bar Organizer Deluxe
                    </h1>
                    <div class="flex items-center space-x-3">
                        <span id="editModeStatus" class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-600">Ansichtsmodus</span>
                        <button id="editModeButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">
                            <i class="fas fa-lock mr-2"></i> Bearbeitungsmodus
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <input type="text" id="searchInput" placeholder="Suche nach Name oder Zutat..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow shadow-sm">
                    <div class="flex space-x-2 bg-gray-800 p-1 rounded-lg shadow-sm">
                        <button data-type="Alles" class="filter-btn flex-1 py-2 px-3 rounded-md text-sm font-medium hover:bg-indigo-600 transition-colors">Alles</button>
                        <button data-type="Mocktail" class="filter-btn flex-1 py-2 px-3 rounded-md text-sm font-medium hover:bg-indigo-600 transition-colors">Mocktails</button>
                        <button data-type="Cocktail" class="filter-btn flex-1 py-2 px-3 rounded-md text-sm font-medium hover:bg-indigo-600 transition-colors">Cocktails</button>
                    </div>
                </div>
            </header>

            <div class="flex justify-between items-center mb-6">
                <h2 id="categoryTitle" class="text-3xl font-semibold text-indigo-300">Drinks</h2>
                 <button id="addDrinkButton" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                    <i class="fas fa-plus mr-2"></i> Drink Hinzuf√ºgen
                </button>
            </div>
            <div id="loadingIndicator" class="hidden text-center py-10">
                <i class="fas fa-spinner fa-spin fa-3x text-indigo-400"></i>
                <p class="mt-2 text-lg">Lade Daten...</p>
            </div>
            <div id="noDrinksMessage" class="hidden text-center py-10 text-gray-400 text-xl">
                Keine Drinks gefunden.
            </div>
            <div id="drinksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </main>
    </div>


    <div id="accessKeyModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-indigo-400">Zugriffsschl√ºssel Eingeben</h3>
            <input type="password" id="accessKeyInput" placeholder="Schl√ºssel" class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-3 mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <p id="accessKeyError" class="text-red-400 text-sm mb-4 h-5"></p>
            <div class="flex justify-end space-x-3">
                <button id="accessKeyCancel" class="px-5 py-2 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors">Abbrechen</button>
                <button id="accessKeySubmit" class="px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition-colors text-white">Best√§tigen</button>
            </div>
        </div>
    </div>

    <div id="drinkModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 overflow-y-auto">
        <form id="drinkForm" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl space-y-6 max-h-[90vh] overflow-y-auto">
            <h3 id="drinkModalTitle" class="text-2xl font-bold text-indigo-400">Drink Bearbeiten</h3>
            <input type="hidden" id="drinkId">
            <div>
                <label for="drinkName" class="block text-sm font-medium text-gray-300 mb-1">Name*</label>
                <input type="text" id="drinkName" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="drinkType" class="block text-sm font-medium text-gray-300 mb-1">Typ*</label>
                    <select id="drinkType" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Mocktail">Mocktail</option>
                        <option value="Cocktail">Cocktail</option>
                    </select>
                </div>
                <div>
                    <label for="drinkCategory" class="block text-sm font-medium text-gray-300 mb-1">Kategorie*</label>
                    <select id="drinkCategory" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </select>
                </div>
            </div>
            <div>
                <label for="drinkSymbols" class="block text-sm font-medium text-gray-300 mb-1">Symbole (Emoji)</label>
                <input type="text" id="drinkSymbols" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Zutaten*</label>
                <div id="ingredientsContainer" class="space-y-2">
                    </div>
                <button type="button" id="addIngredientBtn" class="mt-2 text-sm text-indigo-400 hover:text-indigo-300 font-semibold"><i class="fas fa-plus-circle mr-1"></i> Zutat hinzuf√ºgen</button>
            </div>
            <div>
                <label for="drinkRecipe" class="block text-sm font-medium text-gray-300 mb-1">Rezept*</label>
                <textarea id="drinkRecipe" rows="4" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-700">
                <button type="button" id="drinkCancel" class="px-5 py-2 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors">Abbrechen</button>
                <button type="submit" class="px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition-colors text-white">Speichern</button>
            </div>
        </form>
    </div>

    <div id="categoryModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
        <form id="categoryForm" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md space-y-6">
            <h3 id="categoryModalTitle" class="text-2xl font-bold text-indigo-400">Kategorie Bearbeiten</h3>
            <input type="hidden" id="categoryId">
            <div>
                <label for="categoryName" class="block text-sm font-medium text-gray-300 mb-1">Kategoriename*</label>
                <input type="text" id="categoryName" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-700">
                <button type="button" id="categoryCancel" class="px-5 py-2 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors">Abbrechen</button>
                <button type="submit" class="px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition-colors text-white">Speichern</button>
            </div>
        </form>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4 text-yellow-400">Best√§tigung</h3>
            <p id="confirmModalText" class="text-gray-300 mb-6">M√∂chtest du wirklich fortfahren?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmNo" class="px-5 py-2 rounded-md bg-gray-600 hover:bg-gray-500 transition-colors">Nein</button>
                <button id="confirmYes" class="px-5 py-2 rounded-md bg-red-600 hover:bg-red-700 transition-colors text-white">Ja</button>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mr-3"></i>
                <h3 class="text-xl font-semibold text-yellow-400">Hinweis</h3>
            </div>
            <p id="customAlertText" class="text-gray-300 mb-6">Eine Nachricht.</p>
            <div class="flex justify-end">
                <button id="customAlertCloseBtn" class="px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition-colors text-white">OK</button>
            </div>
        </div>
    </div>

</body>
</html>
