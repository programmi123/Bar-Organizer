<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Organizer Deluxe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb; /* gray-200 */
        }
        .dark ::-webkit-scrollbar-track {
            background: #374151; /* dark:gray-700 */
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af; /* gray-400 */
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563; /* dark:gray-600 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #525c6b; /* dark:gray-500/700 */
        }
        .drink-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .drink-card:hover {
            transform: translateY(-5px);
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.6);
        }
        .category-active {
            background-color: #4f46e5 !important; /* indigo-600 */
            color: white !important;
        }
        .dark .category-active {
            background-color: #6366f1 !important; /* indigo-500 */
        }
        /* Sidebar transition */
        #sidebar {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }
        #mainContentArea {
            transition: margin-left 0.3s ease-in-out;
        }
        /* Print styles */
        @media print {
            .print-hidden { display: none !important; }
            body, .drink-card, .modal-content {
                background-color: white !important;
                color: black !important;
            }
            .drink-card {
                box-shadow: none !important;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            #drinksContainer {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important; /* Single column for printing */
            }
            .text-indigo-400, .text-indigo-300 { color: #3730a3 !important; } /* Darker indigo for print */
        }
    </style>
</head>
<body class="font-sans leading-normal tracking-normal antialiased">

    <div class="flex h-screen overflow-hidden bg-gray-100 dark:bg-gray-900">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full lg:translate-x-0 lg:sticky lg:flex-shrink-0 h-full overflow-y-auto print-hidden">
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Kategorien</h2>
                    <button id="addCategoryButton" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors">
                        <i class="fas fa-plus mr-1"></i> Neu
                    </button>
                </div>
                <div id="categoriesContainer" class="space-y-2 max-h-[calc(100vh-150px)] overflow-y-auto pr-1">
                    </div>
            </div>
        </aside>

        <div id="mainContentArea" class="flex-1 flex flex-col overflow-hidden lg:ml-64">
            <header id="mainHeader" class="bg-white dark:bg-gray-800 shadow-md p-3 sm:p-4 print-hidden sticky top-0 z-30">
                <div class="flex items-center justify-between max-w-full mx-auto">
                    <button id="sidebarToggle" class="text-gray-700 dark:text-gray-200 focus:outline-none lg:hidden p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex-1 min-w-0">
                         <h1 class="text-xl sm:text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 truncate text-center lg:text-left">
                            Bar Organizer
                        </h1>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-3">
                        <div id="settingsContainer" class="relative">
                            <button id="settingsButton" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                                <i class="fas fa-cog text-gray-700 dark:text-gray-200"></i>
                            </button>
                            <div id="settingsDropdown" class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-gray-700 rounded-md shadow-xl z-50 py-1">
                                <a href="#" data-theme="light" class="theme-option block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                    <i class="fas fa-sun mr-2"></i>Hell
                                </a>
                                <a href="#" data-theme="dark" class="theme-option block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                    <i class="fas fa-moon mr-2"></i>Dunkel
                                </a>
                                <a href="#" data-theme="system" class="theme-option block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                    <i class="fas fa-desktop mr-2"></i>System
                                </a>
                            </div>
                        </div>
                        <span id="editModeStatus" class="hidden sm:inline-block px-3 py-1 rounded-full text-xs sm:text-sm font-semibold bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100">Ansichtsmodus</span>
                        <button id="editModeButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-colors text-xs sm:text-sm whitespace-nowrap">
                            <i class="fas fa-lock mr-1"></i> <span class="hidden sm:inline">Bearbeiten</span>
                        </button>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-950 p-4 sm:p-6 md:p-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <input type="text" id="searchInput" placeholder="Suche nach Name oder Zutat..." class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow shadow-sm text-gray-800 dark:text-gray-100">
                    <div class="flex space-x-1 sm:space-x-2 bg-white dark:bg-gray-800 p-1 rounded-lg shadow-sm">
                        <button data-type="Alles" class="filter-btn flex-1 py-2 px-2 sm:px-3 rounded-md text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">Alles</button>
                        <button data-type="Mocktail" class="filter-btn flex-1 py-2 px-2 sm:px-3 rounded-md text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">Mocktails</button>
                        <button data-type="Cocktail" class="filter-btn flex-1 py-2 px-2 sm:px-3 rounded-md text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">Cocktails</button>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-6">
                    <h2 id="categoryTitle" class="text-2xl sm:text-3xl font-semibold text-indigo-700 dark:text-indigo-300 truncate">Drinks</h2>
                    <button id="addDrinkButton" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 sm:px-4 rounded-lg text-xs sm:text-sm transition-colors whitespace-nowrap">
                        <i class="fas fa-plus mr-1 sm:mr-2"></i> Drink Hinzufügen
                    </button>
                </div>
                <div id="loadingIndicator" class="hidden text-center py-10">
                    <i class="fas fa-spinner fa-spin fa-3x text-indigo-500 dark:text-indigo-400"></i>
                    <p class="mt-2 text-lg text-gray-700 dark:text-gray-300">Lade Daten...</p>
                </div>
                <div id="noDrinksMessage" class="hidden text-center py-10 text-gray-500 dark:text-gray-400 text-xl">
                    Keine Drinks gefunden.
                </div>
                <div id="drinksContainer" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6">
                    </div>
            </main>
        </div>
    </div>
    
    <div id="sidebarBackdrop" class="hidden fixed inset-0 z-30 bg-black bg-opacity-50 print-hidden lg:hidden"></div>


    <div id="accessKeyModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 print-hidden">
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md modal-content">
            <h3 class="text-xl sm:text-2xl font-bold mb-6 text-indigo-600 dark:text-indigo-400">Zugriffsschlüssel Eingeben</h3>
            <input type="password" id="accessKeyInput" placeholder="Schlüssel" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-4 py-3 mb-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
            <p id="accessKeyError" class="text-red-500 dark:text-red-400 text-sm mb-4 h-5"></p>
            <div class="flex justify-end space-x-3">
                <button id="accessKeyCancel" class="px-4 sm:px-5 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors text-gray-800 dark:text-gray-100">Abbrechen</button>
                <button id="accessKeySubmit" class="px-4 sm:px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition-colors text-white">Bestätigen</button>
            </div>
        </div>
    </div>

    <div id="drinkModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 overflow-y-auto print-hidden">
        <form id="drinkForm" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl space-y-4 sm:space-y-6 max-h-[90vh] overflow-y-auto modal-content">
            <h3 id="drinkModalTitle" class="text-xl sm:text-2xl font-bold text-indigo-600 dark:text-indigo-400">Drink Bearbeiten</h3>
            <input type="hidden" id="drinkId">
            <div>
                <label for="drinkName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name*</label>
                <input type="text" id="drinkName" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="drinkType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Typ*</label>
                    <select id="drinkType" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
                        <option value="Mocktail">Mocktail</option>
                        <option value="Cocktail">Cocktail</option>
                    </select>
                </div>
                <div>
                    <label for="drinkCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategorie*</label>
                    <select id="drinkCategory" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
                        </select>
                </div>
            </div>
            <div>
                <label for="drinkSymbols" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Symbole (Emoji)</label>
                <input type="text" id="drinkSymbols" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Zutaten*</label>
                <div id="ingredientsContainer" class="space-y-2">
                    </div>
                <button type="button" id="addIngredientBtn" class="mt-2 text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 dark:hover:text-indigo-300 font-semibold"><i class="fas fa-plus-circle mr-1"></i> Zutat hinzufügen</button>
            </div>
            <div>
                <label for="drinkRecipe" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rezept*</label>
                <textarea id="drinkRecipe" rows="3" sm:rows="4" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100"></textarea>
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" id="drinkCancel" class="px-4 sm:px-5 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors text-gray-800 dark:text-gray-100">Abbrechen</button>
                <button type="submit" class="px-4 sm:px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition-colors text-white">Speichern</button>
            </div>
        </form>
    </div>

    <div id="categoryModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 print-hidden">
        <form id="categoryForm" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md space-y-6 modal-content">
            <h3 id="categoryModalTitle" class="text-xl sm:text-2xl font-bold text-indigo-600 dark:text-indigo-400">Kategorie Bearbeiten</h3>
            <input type="hidden" id="categoryId">
            <div>
                <label for="categoryName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategoriename*</label>
                <input type="text" id="categoryName" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" id="categoryCancel" class="px-4 sm:px-5 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors text-gray-800 dark:text-gray-100">Abbrechen</button>
                <button type="submit" class="px-4 sm:px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition-colors text-white">Speichern</button>
            </div>
        </form>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 print-hidden">
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md modal-content">
            <h3 class="text-lg sm:text-xl font-semibold mb-4 text-yellow-500 dark:text-yellow-400">Bestätigung</h3>
            <p id="confirmModalText" class="text-gray-700 dark:text-gray-300 mb-6">Möchtest du wirklich fortfahren?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmNo" class="px-4 sm:px-5 py-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors text-gray-800 dark:text-gray-100">Nein</button>
                <button id="confirmYes" class="px-4 sm:px-5 py-2 rounded-md bg-red-600 hover:bg-red-700 transition-colors text-white">Ja</button>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 print-hidden">
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md modal-content">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-500 dark:text-yellow-400 text-2xl mr-3"></i>
                <h3 class="text-lg sm:text-xl font-semibold text-yellow-500 dark:text-yellow-400">Hinweis</h3>
            </div>
            <p id="customAlertText" class="text-gray-700 dark:text-gray-300 mb-6">Eine Nachricht.</p>
            <div class="flex justify-end">
                <button id="customAlertCloseBtn" class="px-4 sm:px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 transition-colors text-white">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, child, remove, push, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // User-provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAVEM6X3OEUuCDBrpShe02Rnq8p13oEf4s",
            authDomain: "bar-organizer-f3784.firebaseapp.com",
            databaseURL: "https://bar-organizer-f3784-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bar-organizer-f3784",
            storageBucket: "bar-organizer-f3784.firebasestorage.app",
            messagingSenderId: "908059088110",
            appId: "1:908059088110:web:03b861013c137ef1e2cfff",
            measurementId: "G-M99V8FNP35"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database);

        // --- Global State ---
        let allCategories = {};
        let allDrinks = {};
        let currentFilterType = "Alles"; // Mocktail, Cocktail, Alles
        let currentSearchQuery = "";
        let selectedCategoryId = null;
        let editModeActive = false;
        const UNCATEGORIZED_ID = "uncategorized";
        const UNCATEGORIZED_NAME = "Unkategorisiert";
        const COCKTAILS_CATEGORY_NAME_LOWER = "cocktails"; // For default selection

        // --- UI Elements ---
        const categoriesContainer = document.getElementById('categoriesContainer');
        const drinksContainer = document.getElementById('drinksContainer');
        const searchInput = document.getElementById('searchInput');
        const editModeButton = document.getElementById('editModeButton');
        const editModeStatus = document.getElementById('editModeStatus');
        const addCategoryButton = document.getElementById('addCategoryButton');
        const addDrinkButton = document.getElementById('addDrinkButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noDrinksMessage = document.getElementById('noDrinksMessage');
        const categoryTitle = document.getElementById('categoryTitle');
        const rootHtml = document.documentElement;
        const settingsButton = document.getElementById('settingsButton');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const sidebar = document.getElementById('sidebar');
        const mainContentArea = document.getElementById('mainContentArea');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');


        // --- Modals ---
        const accessKeyModal = document.getElementById('accessKeyModal');
        const accessKeyInput = document.getElementById('accessKeyInput');
        const accessKeyError = document.getElementById('accessKeyError');
        const drinkModal = document.getElementById('drinkModal');
        const drinkForm = document.getElementById('drinkForm');
        const drinkModalTitle = document.getElementById('drinkModalTitle');
        const drinkIdInput = document.getElementById('drinkId');
        const drinkCategorySelect = document.getElementById('drinkCategory');
        const categoryModal = document.getElementById('categoryModal');
        const categoryForm = document.getElementById('categoryForm');
        const categoryModalTitle = document.getElementById('categoryModalTitle');
        const categoryIdInput = document.getElementById('categoryId');
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalText = document.getElementById('confirmModalText');
        let confirmCallback = null;
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertText = document.getElementById('customAlertText');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        // --- Theme Switcher ---
        function applyTheme(theme) {
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                rootHtml.classList.add('dark');
            } else {
                rootHtml.classList.remove('dark');
            }
            localStorage.setItem('theme', theme);
            // Update active state in dropdown
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('bg-indigo-100', opt.dataset.theme === theme);
                opt.classList.toggle('dark:bg-indigo-700', opt.dataset.theme === theme);
            });
        }

        settingsButton.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown.classList.toggle('hidden');
        });

        document.querySelectorAll('.theme-option').forEach(option => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                applyTheme(e.target.closest('.theme-option').dataset.theme);
                settingsDropdown.classList.add('hidden');
            });
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (localStorage.getItem('theme') === 'system') {
                applyTheme('system');
            }
        });
        // Close dropdown if clicked outside
        document.addEventListener('click', (event) => {
            if (!settingsButton.contains(event.target) && !settingsDropdown.contains(event.target)) {
                settingsDropdown.classList.add('hidden');
            }
        });


        // --- Sidebar Toggle ---
        function openMobileSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarBackdrop.classList.remove('hidden');
            sidebarToggle.querySelector('i').classList.remove('fa-bars');
            sidebarToggle.querySelector('i').classList.add('fa-times');
        }

        function closeMobileSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarBackdrop.classList.add('hidden');
            sidebarToggle.querySelector('i').classList.remove('fa-times');
            sidebarToggle.querySelector('i').classList.add('fa-bars');
        }

        sidebarToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            if (sidebar.classList.contains('-translate-x-full')) {
                openMobileSidebar();
            } else {
                closeMobileSidebar();
            }
        });
        sidebarBackdrop.addEventListener('click', closeMobileSidebar);


        // --- Initial Data Setup ---
        async function initializeDefaultData() {
            const keySnapshot = await get(child(dbRef, 'barOrganizerData/Key'));
            if (!keySnapshot.exists()) {
                console.log("Datenbank scheint leer zu sein. Initialisiere Standarddaten...");
                const defaultCategories = {
                    [UNCATEGORIZED_ID]: { name: UNCATEGORIZED_NAME, order: 999 }, // Ensure it's last if sorted by order
                    "cat_cocktails": { name: "Cocktails", order: 1 },
                    "cat_mocktails": { name: "Mocktails", order: 2 }
                };
                const defaultDrinks = {
                    "drink_pussycat": { name: "Pussy Cat", type: "Mocktail", categoryId: "cat_mocktails", ingredients: [{ item: "Cassissirup", amount: "2 cl" }, { item: "Ananassaft", amount: "6 cl" }, { item: "Orangensaft", amount: "6 cl" }, { item: "Grapefruitsaft", amount: "6 cl" }], recipe: "Mit Eiswürfeln im Shaker gut schütteln...", symbols: "🍹" },
                    "drink_tropical": { name: "Tropical", type: "Mocktail", categoryId: "cat_mocktails", ingredients: [{ item: "Mandelsirup", amount: "2 cl" }, { item: "Pfefferminzsirup", amount: "2 cl" }, { item: "Milch", amount: "nach Bedarf" }], recipe: "Mandelsirup und Pfefferminzsirup in ein Longdrinkglas...", symbols: "🥛" },
                    "drink_mojito": { name: "Mojito", type: "Cocktail", categoryId: "cat_cocktails", ingredients: [{ item: "Weißer Rum", amount: "5 cl" }, { item: "Limettensaft", amount: "2.5 cl" }], recipe: "Minzblätter mit Zucker und Limettensaft...", symbols: "🌿" }
                };
                await set(child(dbRef, 'barOrganizerData'), {
                    Key: "geheim123",
                    categories: defaultCategories,
                    drinks: defaultDrinks
                });
                console.log("Standarddaten initialisiert.");
            }
        }

        // --- Firebase Data Listeners ---
        function loadData() {
            loadingIndicator.classList.remove('hidden');
            onValue(child(dbRef, 'barOrganizerData/categories'), (snapshot) => {
                allCategories = snapshot.val() || {};
                 // Ensure Uncategorized exists in data structure, but visibility is handled by renderCategories
                if (!allCategories[UNCATEGORIZED_ID]) {
                    allCategories[UNCATEGORIZED_ID] = { name: UNCATEGORIZED_NAME, order: 999 };
                }
                processDataChange();
            });

            onValue(child(dbRef, 'barOrganizerData/drinks'), (snapshot) => {
                allDrinks = snapshot.val() || {};
                processDataChange();
            });
        }
        
        let dataProcessingTimeout = null;
        function processDataChange() {
            // Debounce rendering calls to avoid multiple rapid updates if both categories and drinks change close together
            clearTimeout(dataProcessingTimeout);
            dataProcessingTimeout = setTimeout(() => {
                setDefaultSelectedCategory();
                renderCategories();
                populateCategorySelect();
                filterAndRenderDrinks();
                updateEditModeUI(); // To refresh buttons based on new category/drink counts
                loadingIndicator.classList.add('hidden');
            }, 50); // 50ms debounce
        }


        // --- Rendering Functions ---
        function renderCategories() {
            categoriesContainer.innerHTML = '';
            const hasUncategorizedDrinks = Object.values(allDrinks).some(drink => drink.categoryId === UNCATEGORIZED_ID);
            
            // Filter categories to display: Uncategorized only if it has drinks or in edit mode (and not the only category if empty)
            // Or if it's the only category overall.
            let categoriesToRender = Object.entries(allCategories).filter(([id, category]) => {
                if (id === UNCATEGORIZED_ID) {
                    if (Object.keys(allCategories).length === 1) return true; // Always show if it's the only one
                    return hasUncategorizedDrinks || editModeActive;
                }
                return true;
            });

            // Sort categories by order, then by name
            categoriesToRender.sort(([, a], [, b]) => {
                const orderA = a.order !== undefined ? a.order : 999;
                const orderB = b.order !== undefined ? b.order : 999;
                if (orderA !== orderB) return orderA - orderB;
                return a.name.localeCompare(b.name);
            });


            if (categoriesToRender.length === 0 && allCategories[UNCATEGORIZED_ID]) {
                // This case should ideally not happen if Uncategorized is always in allCategories
                // But as a fallback, if nothing else is renderable, show Uncategorized
                 categoriesToRender.push([UNCATEGORIZED_ID, allCategories[UNCATEGORIZED_ID]]);
            }


            categoriesToRender.forEach(([id, category]) => {
                const isActive = id === selectedCategoryId;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `p-3 mb-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150 ease-in-out flex justify-between items-center text-gray-700 dark:text-gray-200 ${isActive ? 'bg-indigo-100 dark:bg-indigo-700 category-active' : 'bg-gray-50 dark:bg-gray-750'}`;
                
                let buttonsHtml = '';
                if (editModeActive) {
                    if (id !== UNCATEGORIZED_ID) {
                        buttonsHtml += `<button data-id="${id}" class="edit-category-btn text-yellow-500 dark:text-yellow-400 hover:text-yellow-600 dark:hover:text-yellow-300 p-1"><i class="fas fa-edit"></i></button>`;
                        if (Object.keys(allCategories).filter(catId => catId !== UNCATEGORIZED_ID).length > 1 || (Object.keys(allCategories).length > 1 && !allCategories[UNCATEGORIZED_ID])) { // Allow delete if more than one non-uncategorized, or if Uncategorized doesn't exist and there are multiple
                             buttonsHtml += `<button data-id="${id}" class="delete-category-btn text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 p-1"><i class="fas fa-trash"></i></button>`;
                        }
                    } else { // Uncategorized category
                         buttonsHtml += `<button data-id="${id}" class="edit-category-btn text-yellow-500 dark:text-yellow-400 hover:text-yellow-600 dark:hover:text-yellow-300 p-1"><i class="fas fa-edit"></i></button>`;
                    }
                }
                categoryDiv.innerHTML = `<span class="font-semibold truncate pr-2">${category.name}</span> ${buttonsHtml ? `<div class="space-x-1 flex-shrink-0">${buttonsHtml}</div>` : ''}`;
                
                categoryDiv.addEventListener('click', (e) => {
                    if (e.target.closest('.edit-category-btn') || e.target.closest('.delete-category-btn')) return;
                    selectedCategoryId = id;
                    closeMobileSidebar(); // Close sidebar on mobile after selection
                    renderCategories(); 
                    filterAndRenderDrinks();
                });
                categoriesContainer.appendChild(categoryDiv);
            });

            document.querySelectorAll('.edit-category-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); handleEditCategory(btn.dataset.id); }));
            document.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); handleDeleteCategory(btn.dataset.id); }));
        }

        function setDefaultSelectedCategory() {
            const hasUncategorizedDrinks = Object.values(allDrinks).some(drink => drink.categoryId === UNCATEGORIZED_ID);
            const isUncategorizedEffectivelyVisible = (allCategories[UNCATEGORIZED_ID] && (hasUncategorizedDrinks || editModeActive)) || (allCategories[UNCATEGORIZED_ID] && Object.keys(allCategories).length === 1);

            // Check if current selectedCategoryId is still valid and visible
            if (selectedCategoryId && allCategories[selectedCategoryId]) {
                if (selectedCategoryId === UNCATEGORIZED_ID && !isUncategorizedEffectivelyVisible) {
                    selectedCategoryId = null; // Current selection (Uncategorized) is no longer visible, force re-selection
                } else {
                    return; // Current selection is valid
                }
            } else {
                 selectedCategoryId = null; // Invalid current selection
            }
            
            if (!selectedCategoryId) { // If no valid category is selected, find a default
                const cocktailCategoryEntry = Object.entries(allCategories).find(([id, cat]) => cat.name.toLowerCase() === COCKTAILS_CATEGORY_NAME_LOWER && (id !== UNCATEGORIZED_ID || isUncategorizedEffectivelyVisible));
                
                if (cocktailCategoryEntry) {
                    selectedCategoryId = cocktailCategoryEntry[0];
                } else {
                    // Get all potentially visible categories, sorted by order then name
                    const visibleCategoryIds = Object.entries(allCategories)
                        .filter(([id, cat]) => id !== UNCATEGORIZED_ID || isUncategorizedEffectivelyVisible)
                        .sort(([,a],[,b]) => (a.order ?? 999) - (b.order ?? 999) || a.name.localeCompare(b.name))
                        .map(([id]) => id);

                    if (visibleCategoryIds.length > 0) {
                        selectedCategoryId = visibleCategoryIds[0]; // Select the first visible category
                    } else {
                        selectedCategoryId = null; // No categories to select
                    }
                }
            }
        }


        function filterAndRenderDrinks() {
            const currentCategory = allCategories[selectedCategoryId];
            const currentCategoryName = currentCategory?.name || "Alle Drinks";
            categoryTitle.textContent = currentCategoryName;
            drinksContainer.innerHTML = '';
            noDrinksMessage.classList.add('hidden');

            if (!selectedCategoryId && Object.keys(allCategories).length > 0) {
                // This should be handled by setDefaultSelectedCategory, but as a fallback:
                setDefaultSelectedCategory(); // Attempt to set a default if none is selected
                if (!selectedCategoryId) { // Still no category selected
                     noDrinksMessage.textContent = "Bitte wähle eine Kategorie.";
                     noDrinksMessage.classList.remove('hidden');
                     addDrinkButton.classList.add('hidden');
                     return;
                }
            }


            const drinksToDisplay = Object.entries(allDrinks).filter(([id, drink]) => {
                let drinkActualCategoryId = drink.categoryId;
                if (!allCategories[drinkActualCategoryId]) { // If drink's category doesn't exist
                    drinkActualCategoryId = UNCATEGORIZED_ID; 
                }

                const matchesCategory = drinkActualCategoryId === selectedCategoryId;
                const matchesType = currentFilterType === "Alles" || drink.type === currentFilterType;
                
                const searchLower = currentSearchQuery.toLowerCase();
                const nameMatch = drink.name.toLowerCase().includes(searchLower);
                const ingredients = drink.ingredients || [];
                const ingredientMatch = searchLower === "" || ingredients.some(ing => 
                    (ing.item && ing.item.toLowerCase().includes(searchLower)) || 
                    (ing.amount && ing.amount.toLowerCase().includes(searchLower))
                );
                
                return matchesCategory && matchesType && (nameMatch || ingredientMatch);
            });

            if (drinksToDisplay.length === 0) {
                noDrinksMessage.classList.remove('hidden');
                noDrinksMessage.textContent = `Keine Drinks in "${currentCategoryName}" gefunden${currentSearchQuery ? ` für "${currentSearchQuery}"` : ''}.`;
            } else {
                 drinksToDisplay.sort(([,a], [,b]) => a.name.localeCompare(b.name)); // Sort drinks by name
            }

            drinksToDisplay.forEach(([id, drink]) => {
                const drinkCard = document.createElement('div');
                drinkCard.className = 'bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg drink-card hover:shadow-xl';
                drinkCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2 sm:mb-3">
                        <h3 class="text-lg sm:text-xl md:text-2xl font-bold text-indigo-600 dark:text-indigo-400">${drink.name} <span class="text-base sm:text-lg">${drink.symbols || ''}</span></h3>
                        <span class="text-xs sm:text-sm px-2 sm:px-3 py-1 rounded-full ${drink.type === 'Mocktail' ? 'bg-green-500 dark:bg-green-600' : 'bg-red-500 dark:bg-red-600'} text-white">${drink.type}</span>
                    </div>
                    <div class="mb-3 sm:mb-4">
                        <h4 class="font-semibold text-gray-700 dark:text-indigo-300 mb-1 text-sm sm:text-base">Zutaten:</h4>
                        <ul class="list-disc list-inside text-gray-600 dark:text-gray-300 space-y-1 text-xs sm:text-sm">
                            ${(drink.ingredients || []).map(ing => `<li>${ing.amount} ${ing.item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mb-3 sm:mb-4">
                        <h4 class="font-semibold text-gray-700 dark:text-indigo-300 mb-1 text-sm sm:text-base">Rezept:</h4>
                        <p class="text-gray-500 dark:text-gray-400 text-xs sm:text-sm">${drink.recipe}</p>
                    </div>
                    ${editModeActive ? `
                        <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2 sm:space-x-3">
                            <button data-id="${id}" class="edit-drink-btn text-yellow-500 dark:text-yellow-400 hover:text-yellow-600 dark:hover:text-yellow-300 px-2 sm:px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-xs sm:text-sm"><i class="fas fa-edit mr-1"></i> Bearbeiten</button>
                            <button data-id="${id}" class="delete-drink-btn text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 px-2 sm:px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-xs sm:text-sm"><i class="fas fa-trash mr-1"></i> Löschen</button>
                        </div>
                    ` : ''}
                `;
                drinksContainer.appendChild(drinkCard);
            });

            document.querySelectorAll('.edit-drink-btn').forEach(btn => btn.addEventListener('click', () => handleEditDrink(btn.dataset.id)));
            document.querySelectorAll('.delete-drink-btn').forEach(btn => btn.addEventListener('click', () => handleDeleteDrink(btn.dataset.id)));
            
            updateAddDrinkButtonVisibility();
        }
        
        function updateAddDrinkButtonVisibility() {
             if (editModeActive && selectedCategoryId && allCategories[selectedCategoryId]) {
                addDrinkButton.classList.remove('hidden');
            } else {
                addDrinkButton.classList.add('hidden');
            }
        }


        // --- Edit Mode ---
        editModeButton.addEventListener('click', () => {
            if (editModeActive) {
                editModeActive = false;
                updateEditModeUI();
            } else {
                accessKeyInput.value = '';
                accessKeyError.textContent = '';
                accessKeyModal.classList.remove('hidden');
            }
        });

        document.getElementById('accessKeySubmit').addEventListener('click', async () => {
            const keyAttempt = accessKeyInput.value;
            if (!keyAttempt) {
                 accessKeyError.textContent = 'Schlüssel darf nicht leer sein.';
                 return;
            }
            const dbKeySnapshot = await get(child(dbRef, 'barOrganizerData/Key'));
            const correctKey = dbKeySnapshot.val();

            if (keyAttempt === correctKey) {
                editModeActive = true;
                updateEditModeUI();
                accessKeyModal.classList.add('hidden');
            } else {
                accessKeyError.textContent = 'Ungültiger Schlüssel.';
            }
        });
        document.getElementById('accessKeyCancel').addEventListener('click', () => accessKeyModal.classList.add('hidden'));

        function updateEditModeUI() {
            const editModeButtonIcon = editModeButton.querySelector('i');
            const editModeButtonText = editModeButton.querySelector('span');

            if (editModeActive) {
                editModeButtonIcon.classList.remove('fa-lock');
                editModeButtonIcon.classList.add('fa-lock-open');
                if(editModeButtonText) editModeButtonText.textContent = 'Verlassen';
                editModeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                editModeButton.classList.add('bg-red-500', 'hover:bg-red-600');
                editModeStatus.textContent = 'Bearbeiten Aktiv';
                editModeStatus.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                editModeStatus.classList.add('bg-yellow-400', 'dark:bg-yellow-500', 'text-gray-900', 'dark:text-gray-900');
                addCategoryButton.classList.remove('hidden');
            } else {
                editModeButtonIcon.classList.remove('fa-lock-open');
                editModeButtonIcon.classList.add('fa-lock');
                if(editModeButtonText) editModeButtonText.textContent = 'Bearbeiten';
                editModeButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                editModeButton.classList.add('bg-green-500', 'hover:bg-green-600');
                editModeStatus.textContent = 'Ansichtsmodus';
                editModeStatus.classList.remove('bg-yellow-400', 'dark:bg-yellow-500', 'text-gray-900', 'dark:text-gray-900');
                editModeStatus.classList.add('bg-gray-200', 'dark:bg-gray-700');
                addCategoryButton.classList.add('hidden');
            }
            renderCategories(); // Re-render to show/hide category edit buttons & handle Uncategorized visibility
            filterAndRenderDrinks(); // Re-render to show/hide drink edit buttons
            updateAddDrinkButtonVisibility();
        }

        // --- Search and Filter ---
        searchInput.addEventListener('input', (e) => {
            currentSearchQuery = e.target.value; // Keep case for potential future case-sensitive search, convert toLower in filter
            filterAndRenderDrinks();
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-indigo-500', 'dark:bg-indigo-600', 'text-white', 'dark:text-white', 'ring-2', 'ring-indigo-400');
                    b.classList.add('text-gray-700', 'dark:text-gray-200', 'hover:bg-gray-200', 'dark:hover:bg-gray-700');
                });
                btn.classList.add('bg-indigo-500', 'dark:bg-indigo-600', 'text-white', 'dark:text-white');
                btn.classList.remove('text-gray-700', 'dark:text-gray-200', 'hover:bg-gray-200', 'dark:hover:bg-gray-700');
                currentFilterType = btn.dataset.type;
                filterAndRenderDrinks();
            });
        });

        // --- Category CRUD ---
        addCategoryButton.addEventListener('click', () => openCategoryModal());

        function openCategoryModal(id = null) {
            categoryForm.reset();
            categoryIdInput.value = id || '';
            const categoryOrderInput = document.getElementById('categoryOrder');
            if (id && allCategories[id]) {
                categoryModalTitle.textContent = 'Kategorie Bearbeiten';
                document.getElementById('categoryName').value = allCategories[id].name;
                categoryOrderInput.value = allCategories[id].order !== undefined ? allCategories[id].order : '';
            } else {
                categoryModalTitle.textContent = 'Neue Kategorie Erstellen';
                // Suggest next available order number
                const existingOrders = Object.values(allCategories).map(c => c.order).filter(o => o !== undefined);
                const maxOrder = existingOrders.length > 0 ? Math.max(...existingOrders) : 0;
                categoryOrderInput.value = maxOrder + 1;
            }
            // Add order input to category modal if not present
            if (!categoryOrderInput) {
                 const nameLabel = categoryForm.querySelector('label[for="categoryName"]');
                 const orderDiv = document.createElement('div');
                 orderDiv.innerHTML = `
                    <label for="categoryOrder" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reihenfolge (optional)</label>
                    <input type="number" id="categoryOrder" placeholder="z.B. 1, 2, 3..." class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
                 `;
                 nameLabel.parentElement.after(orderDiv);
            }
            categoryModal.classList.remove('hidden');
        }

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = categoryIdInput.value;
            const name = document.getElementById('categoryName').value.trim();
            const orderInput = document.getElementById('categoryOrder').value;
            const order = orderInput === '' ? null : parseInt(orderInput, 10);


            if (!name) {
                showCustomAlert("Kategoriename darf nicht leer sein.");
                return;
            }

            const categoryData = { name };
            if (order !== null && !isNaN(order)) {
                categoryData.order = order;
            } else if (id && allCategories[id] && allCategories[id].order !== undefined) { // if clearing order, remove it
                categoryData.order = null; // Firebase removes field if value is null
            }


            try {
                if (id) {
                    await update(child(dbRef, `barOrganizerData/categories/${id}`), categoryData);
                } else {
                    const newCategoryRef = push(child(dbRef, 'barOrganizerData/categories'));
                    await set(newCategoryRef, categoryData);
                }
                categoryModal.classList.add('hidden');
            } catch (error) {
                console.error("Fehler beim Speichern der Kategorie:", error);
                showCustomAlert("Fehler beim Speichern der Kategorie.");
            }
        });
        document.getElementById('categoryCancel').addEventListener('click', () => categoryModal.classList.add('hidden'));

        function handleEditCategory(id) {
            openCategoryModal(id);
        }

        async function handleDeleteCategory(id) {
            if (id === UNCATEGORIZED_ID) {
                showCustomAlert("Die 'Unkategorisiert' Kategorie kann nicht gelöscht werden.");
                return;
            }
            // Count non-uncategorized categories
            const normalCategoriesCount = Object.keys(allCategories).filter(catId => catId !== UNCATEGORIZED_ID).length;
            if (normalCategoriesCount <= 1 && allCategories[id]) { // Check if it's the last "normal" category
                 showCustomAlert("Die letzte reguläre Kategorie kann nicht gelöscht werden. Es muss immer mindestens eine reguläre Kategorie neben 'Unkategorisiert' geben, wenn 'Unkategorisiert' Drinks enthält oder der Bearbeitungsmodus aktiv ist.");
                 return;
            }


            showConfirmModal(`Sicher, dass du die Kategorie "${allCategories[id].name}" löschen willst? Alle Drinks darin werden als "${UNCATEGORIZED_NAME}" markiert.`, async () => {
                try {
                    const updates = {};
                    Object.entries(allDrinks).forEach(([drinkId, drink]) => {
                        if (drink.categoryId === id) {
                            updates[`barOrganizerData/drinks/${drinkId}/categoryId`] = UNCATEGORIZED_ID;
                        }
                    });
                    if (Object.keys(updates).length > 0) {
                        await update(dbRef, updates);
                    }
                    await remove(child(dbRef, `barOrganizerData/categories/${id}`));
                    
                    if (selectedCategoryId === id) { // If deleted category was selected
                        selectedCategoryId = null; // Force re-evaluation of default
                        setDefaultSelectedCategory(); // This will pick a new default
                        renderCategories(); // Update sidebar display
                        filterAndRenderDrinks(); // Update drinks display
                    }
                    // Data refresh will also be triggered by onValue listeners
                } catch (error) {
                    console.error("Fehler beim Löschen der Kategorie:", error);
                    showCustomAlert("Fehler beim Löschen der Kategorie.");
                }
            });
        }

        // --- Drink CRUD ---
        addDrinkButton.addEventListener('click', () => {
            if (selectedCategoryId && allCategories[selectedCategoryId]) {
                openDrinkModal(null, selectedCategoryId);
            } else {
                showCustomAlert("Bitte wähle zuerst eine gültige Kategorie aus, um einen Drink hinzuzufügen.");
            }
        });

        function populateCategorySelect(selectedDrinkCategoryId = null) {
            drinkCategorySelect.innerHTML = '';
            Object.entries(allCategories)
                .filter(([id]) => id !== UNCATEGORIZED_ID) // Never offer "Unkategorisiert" as a choice here
                .sort(([,a],[,b]) => (a.order ?? 999) - (b.order ?? 999) || a.name.localeCompare(b.name))
                .forEach(([id, category]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = category.name;
                    if (selectedDrinkCategoryId === id) {
                        option.selected = true;
                    }
                    drinkCategorySelect.appendChild(option);
                });
            
            // If no category is selected for the drink (e.g. new drink), try to use current sidebar selection
            if (!selectedDrinkCategoryId && selectedCategoryId && allCategories[selectedCategoryId] && selectedCategoryId !== UNCATEGORIZED_ID) {
                 drinkCategorySelect.value = selectedCategoryId;
            } else if (!drinkCategorySelect.value && drinkCategorySelect.options.length > 0) {
                // If still no value (e.g. current sidebar selection was Uncategorized), pick the first in the list
                drinkCategorySelect.value = drinkCategorySelect.options[0].value;
            }
        }

        function openDrinkModal(id = null, currentCatIdForNewDrink = null) {
            drinkForm.reset();
            document.getElementById('ingredientsContainer').innerHTML = '';
            addIngredientField(); 

            drinkIdInput.value = id || '';
            let drinkCategoryIdForSelect = null;

            if (id && allDrinks[id]) {
                drinkModalTitle.textContent = 'Drink Bearbeiten';
                const drink = allDrinks[id];
                document.getElementById('drinkName').value = drink.name;
                document.getElementById('drinkType').value = drink.type;
                document.getElementById('drinkSymbols').value = drink.symbols || '';
                document.getElementById('drinkRecipe').value = drink.recipe;
                drinkCategoryIdForSelect = drink.categoryId === UNCATEGORIZED_ID ? null : drink.categoryId; // If uncategorized, let populateCategorySelect pick default

                if (drink.ingredients && drink.ingredients.length > 0) {
                    document.getElementById('ingredientsContainer').innerHTML = '';
                    drink.ingredients.forEach(ing => addIngredientField(ing.item, ing.amount));
                }
            } else {
                drinkModalTitle.textContent = 'Neuen Drink Erstellen';
                drinkCategoryIdForSelect = (currentCatIdForNewDrink && currentCatIdForNewDrink !== UNCATEGORIZED_ID) ? currentCatIdForNewDrink : null;
            }
            populateCategorySelect(drinkCategoryIdForSelect);
            drinkModal.classList.remove('hidden');
        }

        drinkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = drinkIdInput.value;
            const name = document.getElementById('drinkName').value.trim();
            const type = document.getElementById('drinkType').value;
            const categoryId = drinkCategorySelect.value; // This will be a non-UNCATEGORIZED_ID
            const symbols = document.getElementById('drinkSymbols').value.trim();
            const recipe = document.getElementById('drinkRecipe').value.trim();

            if (!name || !type || !categoryId || !recipe) {
                showCustomAlert("Bitte fülle alle Pflichtfelder aus (Name, Typ, Kategorie, Rezept).");
                return;
            }

            const ingredients = [];
            document.querySelectorAll('.ingredient-field').forEach(field => {
                const item = field.querySelector('input[name="ingredientItem"]').value.trim();
                const amount = field.querySelector('input[name="ingredientAmount"]').value.trim();
                if (item && amount) {
                    ingredients.push({ item, amount });
                }
            });

            if (ingredients.length === 0) {
                showCustomAlert("Bitte füge mindestens eine Zutat hinzu.");
                return;
            }

            const drinkData = { name, type, categoryId, symbols, recipe, ingredients };

            try {
                if (id) {
                    await update(child(dbRef, `barOrganizerData/drinks/${id}`), drinkData);
                } else {
                    const newDrinkRef = push(child(dbRef, 'barOrganizerData/drinks'));
                    await set(newDrinkRef, drinkData);
                }
                drinkModal.classList.add('hidden');
            } catch (error) {
                console.error("Fehler beim Speichern des Drinks:", error);
                showCustomAlert("Fehler beim Speichern des Drinks.");
            }
        });

        document.getElementById('drinkCancel').addEventListener('click', () => drinkModal.classList.add('hidden'));
        document.getElementById('addIngredientBtn').addEventListener('click', () => addIngredientField());

        function addIngredientField(item = '', amount = '') {
            const ingredientsContainer = document.getElementById('ingredientsContainer');
            const newField = document.createElement('div');
            newField.className = 'ingredient-field flex space-x-2 mb-2 items-center';
            newField.innerHTML = `
                <input type="text" name="ingredientItem" placeholder="Zutat" value="${item}" class="flex-grow bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
                <input type="text" name="ingredientAmount" placeholder="Menge" value="${amount}" class="w-1/3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 dark:text-gray-100">
                <button type="button" class="remove-ingredient-btn text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 p-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500"><i class="fas fa-minus-circle"></i></button>
            `;
            ingredientsContainer.appendChild(newField);
            newField.querySelector('.remove-ingredient-btn').addEventListener('click', () => newField.remove());
        }

        function handleEditDrink(id) { openDrinkModal(id); }

        async function handleDeleteDrink(id) {
            showConfirmModal(`Sicher, dass du den Drink "${allDrinks[id].name}" löschen willst?`, async () => {
                try {
                    await remove(child(dbRef, `barOrganizerData/drinks/${id}`));
                } catch (error) {
                    console.error("Fehler beim Löschen des Drinks:", error);
                    showCustomAlert("Fehler beim Löschen des Drinks.");
                }
            });
        }

        // --- Confirm & Alert Modals ---
        function showConfirmModal(text, callback) {
            confirmModalText.textContent = text;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }
        document.getElementById('confirmYes').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
        });
        document.getElementById('confirmNo').addEventListener('click', () => confirmModal.classList.add('hidden'));
        
        function showCustomAlert(message) {
            customAlertText.textContent = message;
            customAlertModal.classList.remove('hidden');
        }
        customAlertCloseBtn.addEventListener('click', () => customAlertModal.classList.add('hidden'));

        // --- Initial Load ---
        async function main() {
            // Apply theme first to avoid FOUC
            const savedTheme = localStorage.getItem('theme') || 'system';
            applyTheme(savedTheme);

            if (window.innerWidth < 1024) { // lg breakpoint
                sidebar.classList.add('-translate-x-full');
                mainContentArea.classList.remove('lg:ml-64');
                sidebarToggle.querySelector('i').classList.remove('fa-times');
                sidebarToggle.querySelector('i').classList.add('fa-bars');
            } else {
                sidebar.classList.remove('-translate-x-full');
                mainContentArea.classList.add('lg:ml-64');
            }
            
            await initializeDefaultData();
            loadData(); // This will trigger processDataChange which calls updateEditModeUI
            
            // Set default filter button active state
            document.querySelector('.filter-btn[data-type="Alles"]').classList.add('bg-indigo-500', 'dark:bg-indigo-600', 'text-white', 'dark:text-white');
            document.querySelector('.filter-btn[data-type="Alles"]').classList.remove('text-gray-700', 'dark:text-gray-200', 'hover:bg-gray-200', 'dark:hover:bg-gray-700');
        }

        main();
    </script>

</body>
</html>
