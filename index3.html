<!DOCTYPE html>
<html lang="de"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Organizer Deluxe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for webkit browsers (light theme) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f3f4f6; /* gray-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af; /* gray-400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

        /* Custom scrollbar for webkit browsers (dark theme) */
        .dark ::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #6b7280; /* gray-500 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* gray-400 */
        }

        .drink-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .drink-card:hover {
            transform: translateY(-5px);
        }
        .modal-backdrop { /* Applied to modal wrapper divs */
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .category-active {
            background-color: #4f46e5 !important; /* indigo-600 */
            color: white !important;
        }
        .dark .category-active {
             background-color: #6366f1 !important; /* indigo-500 */
        }

        /* Ensure fixed header/sidebar don't hide content */
        body {
            padding-top: 0; /* Header is sticky inside mainArea */
        }
        #mainArea {
            padding-top: 0; /* Header is sticky inside mainArea */
        }

        /* Styling for theme option buttons */
        .theme-option-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .dark .theme-option-button.active {
            background-color: #6366f1; /* indigo-500 */
             color: white;
        }
    </style>
    <script>
      // Tailwind dark mode configuration (class-based)
      // This would typically be in tailwind.config.js, but for CDN we manage the class on <html>
      // Ensure the 'dark' class on <html> triggers Tailwind's dark variants.
    </script>
</head>
<body class="font-sans leading-normal tracking-normal bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

    <div class="flex h-screen overflow-hidden">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800 p-4 space-y-4 shadow-xl transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out print:hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">Kategorien</h2>
                <button id="sidebarCloseBtn" class="md:hidden text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="categoriesContainer" class="space-y-1.5 max-h-[calc(100vh-180px)] overflow-y-auto pr-1">
                </div>
            <button id="addCategoryButton" class="hidden w-full mt-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 px-4 rounded-lg text-sm transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                <i class="fas fa-plus mr-2"></i> Kategorie
            </button>
        </aside>

        <div id="sidebarOverlay" class="fixed inset-0 z-30 bg-black opacity-50 hidden md:hidden print:hidden"></div>

        <div id="mainArea" class="flex-1 flex flex-col overflow-auto transition-all duration-300 ease-in-out md:ml-64">
            <header class="sticky top-0 bg-white dark:bg-gray-800 shadow-lg p-3 sm:p-4 z-20 print:hidden">
                <div class="container mx-auto flex items-center justify-between">
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <button id="sidebarOpenBtn" class="text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 focus:outline-none p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-bars fa-lg"></i>
                        </button>
                        <h1 class="text-xl sm:text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500">
                            Bar Organizer Deluxe
                        </h1>
                    </div>

                    <div class="flex items-center space-x-2 sm:space-x-3">
                         <div class="relative hidden sm:block">
                            <input type="text" id="searchInput" placeholder="Suche Drinks, Zutaten (A,B)..." class="w-full md:w-56 lg:w-72 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-shadow shadow-sm">
                            <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 dark:text-gray-500 pointer-events-none">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                        <span id="headerEditModeStatus" class="hidden px-3 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap">Ansichtsmodus</span>
                        <button id="settingsButton" class="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-cog fa-lg"></i>
                        </button>
                    </div>
                </div>
                 <div class="mt-2 sm:hidden px-2"> <div class="relative">
                        <input type="text" id="searchInputMobile" placeholder="Suche Drinks, Zutaten (A,B)..." class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-shadow shadow-sm">
                        <span class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 dark:text-gray-500 pointer-events-none">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
            </header>

            <main class="flex-1 p-4 sm:p-6 md:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 sm:mb-6">
                     <div class="flex space-x-1 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg shadow-sm mb-3 sm:mb-0">
                        <button data-type="Alles" class="filter-btn flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-indigo-500 dark:hover:bg-indigo-600 hover:text-white dark:hover:text-white transition-colors">Alles</button>
                        <button data-type="Mocktail" class="filter-btn flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-indigo-500 dark:hover:bg-indigo-600 hover:text-white dark:hover:text-white transition-colors">Mocktails</button>
                        <button data-type="Cocktail" class="filter-btn flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-indigo-500 dark:hover:bg-indigo-600 hover:text-white dark:hover:text-white transition-colors">Cocktails</button>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h2 id="categoryTitle" class="text-xl sm:text-2xl md:text-3xl font-semibold text-indigo-700 dark:text-indigo-300">Drinks</h2>
                     <button id="addDrinkButton" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-4 rounded-lg text-sm transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75">
                        <i class="fas fa-plus mr-2"></i> Drink
                    </button>
                </div>
                <div id="loadingIndicator" class="hidden text-center py-10">
                    <i class="fas fa-spinner fa-spin fa-3x text-indigo-500 dark:text-indigo-400"></i>
                    <p class="mt-3 text-lg text-gray-600 dark:text-gray-400">Lade Daten...</p>
                </div>
                <div id="noDrinksMessage" class="hidden text-center py-10 text-gray-500 dark:text-gray-400 text-xl">
                    Keine Drinks gefunden.
                </div>
                <div id="drinksContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6">
                    </div>
            </main>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 print:hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Einstellungen</h3>
                <button id="closeSettingsModal" class="text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Theme</label>
                <div class="flex space-x-2 rounded-lg bg-gray-100 dark:bg-gray-700 p-1">
                    <button data-theme-value="light" class="theme-option-button flex-1 py-2 px-3 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Light</button>
                    <button data-theme-value="dark" class="theme-option-button flex-1 py-2 px-3 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">Dark</button>
                    <button data-theme-value="system" class="theme-option-button flex-1 py-2 px-3 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">System</button>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bearbeitungsmodus</label>
                <button id="modalEditModeButton" class="w-full text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition-colors flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-opacity-75">
                    </button>
                 <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-2">Status: <span id="modalEditModeStatusText" class="font-semibold">Aus</span></p>
            </div>
        </div>
    </div>

    <div id="accessKeyModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60] print:hidden">
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl sm:text-2xl font-bold mb-6 text-indigo-600 dark:text-indigo-400">Zugriffsschl√ºssel Eingeben</h3>
            <input type="password" id="accessKeyInput" placeholder="Schl√ºssel" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-4 py-3 mb-1 text-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none">
            <p id="accessKeyError" class="text-red-500 dark:text-red-400 text-sm mt-1 mb-4 h-5"></p>
            <div class="flex justify-end space-x-3">
                <button id="accessKeyCancel" class="px-5 py-2.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400">Abbrechen</button>
                <button id="accessKeySubmit" class="px-5 py-2.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">Best√§tigen</button>
            </div>
        </div>
    </div>

    <div id="drinkModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 overflow-y-auto print:hidden">
        <form id="drinkForm" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl space-y-5 max-h-[90vh] overflow-y-auto">
            <h3 id="drinkModalTitle" class="text-xl sm:text-2xl font-bold text-indigo-600 dark:text-indigo-400">Drink Bearbeiten</h3>
            <input type="hidden" id="drinkId">
            <div>
                <label for="drinkName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name*</label>
                <input type="text" id="drinkName" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2.5 text-gray-700 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="drinkType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Typ*</label>
                    <select id="drinkType" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2.5 text-gray-700 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                        <option value="Mocktail">Mocktail</option>
                        <option value="Cocktail">Cocktail</option>
                    </select>
                </div>
                <div>
                    <label for="drinkCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategorie*</label>
                    <select id="drinkCategory" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2.5 text-gray-700 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    </select>
                </div>
            </div>
            <div>
                <label for="drinkSymbols" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Symbole (Emoji)</label>
                <input type="text" id="drinkSymbols" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2.5 text-gray-700 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Zutaten*</label>
                <div id="ingredientsContainer" class="space-y-2">
                </div>
                <button type="button" id="addIngredientBtn" class="mt-2 text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 dark:hover:text-indigo-300 font-semibold focus:outline-none"><i class="fas fa-plus-circle mr-1"></i> Zutat hinzuf√ºgen</button>
            </div>
            <div>
                <label for="drinkRecipe" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rezept*</label>
                <textarea id="drinkRecipe" rows="4" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2.5 text-gray-700 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 outline-none"></textarea>
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" id="drinkCancel" class="px-5 py-2.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400">Abbrechen</button>
                <button type="submit" class="px-5 py-2.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">Speichern</button>
            </div>
        </form>
    </div>

    <div id="categoryModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 print:hidden">
        <form id="categoryForm" class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md space-y-6">
            <h3 id="categoryModalTitle" class="text-xl sm:text-2xl font-bold text-indigo-600 dark:text-indigo-400">Kategorie Bearbeiten</h3>
            <input type="hidden" id="categoryId">
            <div>
                <label for="categoryName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kategoriename*</label>
                <input type="text" id="categoryName" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2.5 text-gray-700 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" id="categoryCancel" class="px-5 py-2.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400">Abbrechen</button>
                <button type="submit" class="px-5 py-2.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">Speichern</button>
            </div>
        </form>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[70] print:hidden">
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-lg sm:text-xl font-semibold mb-4 text-yellow-600 dark:text-yellow-400">Best√§tigung</h3>
            <p id="confirmModalText" class="text-gray-700 dark:text-gray-300 mb-6">M√∂chtest du wirklich fortfahren?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmNo" class="px-5 py-2.5 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400">Nein</button>
                <button id="confirmYes" class="px-5 py-2.5 rounded-md bg-red-600 hover:bg-red-700 text-white transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-400">Ja</button>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[70] print:hidden">
        <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-500 dark:text-yellow-400 text-2xl mr-3"></i>
                <h3 class="text-lg sm:text-xl font-semibold text-yellow-600 dark:text-yellow-400">Hinweis</h3>
            </div>
            <p id="customAlertText" class="text-gray-700 dark:text-gray-300 mb-6">Eine Nachricht.</p>
            <div class="flex justify-end">
                <button id="customAlertCloseBtn" class="px-5 py-2.5 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, child, remove, push, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // User-provided Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAVEM6X3OEUuCDBrpShe02Rnq8p13oEf4s", // Replace with your actual API key if needed
            authDomain: "bar-organizer-f3784.firebaseapp.com",
            databaseURL: "https://bar-organizer-f3784-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bar-organizer-f3784",
            storageBucket: "bar-organizer-f3784.appspot.com", // Corrected typical storage bucket format
            messagingSenderId: "908059088110",
            appId: "1:908059088110:web:03b861013c137ef1e2cfff",
            measurementId: "G-M99V8FNP35"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database);

        // --- Global State ---
        let allCategories = {};
        let allDrinks = {};
        let currentFilterType = "Alles";
        let currentSearchQuery = "";
        let selectedCategoryId = null;
        let editModeActive = false;
        const UNCATEGORIZED_ID = "uncategorized";
        const UNCATEGORIZED_NAME = "Unkategorisiert";

        // --- UI Elements ---
        const categoriesContainer = document.getElementById('categoriesContainer');
        const drinksContainer = document.getElementById('drinksContainer');
        const searchInput = document.getElementById('searchInput');
        const searchInputMobile = document.getElementById('searchInputMobile');
        
        const addCategoryButton = document.getElementById('addCategoryButton');
        const addDrinkButton = document.getElementById('addDrinkButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noDrinksMessage = document.getElementById('noDrinksMessage');
        const categoryTitle = document.getElementById('categoryTitle');

        // Sidebar elements
        const sidebar = document.getElementById('sidebar');
        const sidebarOpenBtn = document.getElementById('sidebarOpenBtn');
        const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const mainArea = document.getElementById('mainArea');

        // Settings Modal elements
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalButton = document.getElementById('closeSettingsModal');
        const themeOptionButtons = document.querySelectorAll('.theme-option-button');
        const modalEditModeButton = document.getElementById('modalEditModeButton');
        const modalEditModeStatusText = document.getElementById('modalEditModeStatusText');
        const headerEditModeStatus = document.getElementById('headerEditModeStatus');


        // Access Key Modal
        const accessKeyModal = document.getElementById('accessKeyModal');
        const accessKeyInput = document.getElementById('accessKeyInput');
        const accessKeyError = document.getElementById('accessKeyError');

        // Drink Modal
        const drinkModal = document.getElementById('drinkModal');
        const drinkForm = document.getElementById('drinkForm');
        const drinkModalTitle = document.getElementById('drinkModalTitle');
        const drinkIdInput = document.getElementById('drinkId');
        const drinkCategorySelect = document.getElementById('drinkCategory');

        // Category Modal
        const categoryModal = document.getElementById('categoryModal');
        const categoryForm = document.getElementById('categoryForm');
        const categoryModalTitle = document.getElementById('categoryModalTitle');
        const categoryIdInput = document.getElementById('categoryId');

        // Confirm Modal
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalText = document.getElementById('confirmModalText');
        let confirmCallback = null;

        // Custom Alert Modal
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertText = document.getElementById('customAlertText');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

        // --- Sidebar Logic ---
        function toggleSidebar() {
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            if (isOpen) { // Close it
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
                if (window.innerWidth >= 768) { // md breakpoint
                    mainArea.classList.remove('md:ml-64');
                }
            } else { // Open it
                sidebar.classList.remove('-translate-x-full');
                if (window.innerWidth < 768) { // md breakpoint
                    sidebarOverlay.classList.remove('hidden');
                } else {
                    mainArea.classList.add('md:ml-64');
                }
            }
        }
        sidebarOpenBtn.addEventListener('click', toggleSidebar);
        sidebarCloseBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        function initializeSidebarState() {
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
                mainArea.classList.remove('md:ml-64');
                sidebarOverlay.classList.add('hidden');
            } else {
                sidebar.classList.remove('-translate-x-full');
                mainArea.classList.add('md:ml-64');
                sidebarOverlay.classList.add('hidden');
            }
        }
        window.addEventListener('resize', initializeSidebarState);

        // --- Theme Switcher Logic ---
        function applyTheme(themeToApply) {
            const htmlEl = document.documentElement;
            let finalTheme = themeToApply;

            if (themeToApply === 'system') {
                finalTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            if (finalTheme === 'dark') {
                htmlEl.classList.add('dark');
            } else {
                htmlEl.classList.remove('dark'); // Light theme is default (no 'dark' class)
            }
            localStorage.setItem('theme', themeToApply); // Store the user's *choice* (light, dark, or system)
            updateThemeButtonsState(themeToApply);
        }

        function updateThemeButtonsState(activeThemeChoice) {
            themeOptionButtons.forEach(btn => {
                if (btn.dataset.themeValue === activeThemeChoice) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        themeOptionButtons.forEach(button => {
            button.addEventListener('click', () => {
                applyTheme(button.dataset.themeValue);
            });
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (localStorage.getItem('theme') === 'system') {
                applyTheme('system');
            }
        });
        
        // --- Settings Modal Logic ---
        settingsButton.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsModalButton.addEventListener('click', () => settingsModal.classList.add('hidden'));


        // --- Initial Data Setup ---
        async function initializeDefaultData() {
            const snapshot = await get(child(dbRef, 'barOrganizerData/Key'));
            if (!snapshot.exists()) {
                console.log("Datenbank scheint leer zu sein. Initialisiere Standarddaten...");
                const defaultData = {
                    Key: "geheim123",
                    categories: {
                        [UNCATEGORIZED_ID]: { name: UNCATEGORIZED_NAME },
                        "cat_mocktails": { name: "Mocktails" },
                        "cat_cocktails": { name: "Cocktails" }
                    },
                    drinks: {
                        "drink_pussycat": {
                            name: "Pussy Cat", type: "Mocktail", categoryId: "cat_mocktails",
                            ingredients: [{ item: "Cassissirup", amount: "2 cl" }, { item: "Ananassaft", amount: "6 cl" }, { item: "Orangensaft", amount: "6 cl" }, { item: "Grapefruitsaft", amount: "6 cl" }],
                            recipe: "Mit Eisw√ºrfeln im Shaker gut sch√ºtteln, in ein gro√ües Longdrinkglas auf einige Eisw√ºrfel abgie√üen und mit Fr√ºchten garnieren. Trinkhalm dazugeben.", symbols: "üçπ"
                        },
                        "drink_tropical": {
                            name: "Tropical", type: "Mocktail", categoryId: "cat_mocktails",
                            ingredients: [{ item: "Mandelsirup", amount: "2 cl" }, { item: "Pfefferminzsirup", amount: "2 cl" }, { item: "Milch", amount: "nach Bedarf" }],
                            recipe: "Mandelsirup und Pfefferminzsirup in ein Longdrinkglas geben und mit kalter Milch auff√ºllen.", symbols: "ü•õ"
                        },
                         "drink_mojito": {
                            name: "Mojito", type: "Cocktail", categoryId: "cat_cocktails",
                            ingredients: [{ item: "Wei√üer Rum", amount: "5 cl" }, { item: "Limettensaft", amount: "2.5 cl" }, { item: "Zuckersirup", amount: "2 cl" }, { item: "Minzbl√§tter", amount: "8-10" }, {item: "Sodawasser", amount: "Auff√ºllen"}],
                            recipe: "Minzbl√§tter mit Zucker und Limettensaft im Glas leicht andr√ºcken. Glas mit Crushed Ice f√ºllen, Rum dazugeben und mit Sodawasser auff√ºllen. Vorsichtig umr√ºhren.", symbols: "üåø"
                        }
                    }
                };
                await set(child(dbRef, 'barOrganizerData'), defaultData);
                console.log("Standarddaten initialisiert.");
            }
        }

        // --- Firebase Data Listeners ---
        function loadData() {
            loadingIndicator.classList.remove('hidden');
            onValue(child(dbRef, 'barOrganizerData/categories'), (snapshot) => {
                allCategories = snapshot.val() || {};
                if (!allCategories[UNCATEGORIZED_ID]) {
                    allCategories[UNCATEGORIZED_ID] = { name: UNCATEGORIZED_NAME };
                }
                renderCategories();
                populateCategorySelect();
                if (!selectedCategoryId || !allCategories[selectedCategoryId]) {
                    selectedCategoryId = Object.keys(allCategories)[0] || UNCATEGORIZED_ID;
                }
                filterAndRenderDrinks();
                loadingIndicator.classList.add('hidden');
            });

            onValue(child(dbRef, 'barOrganizerData/drinks'), (snapshot) => {
                allDrinks = snapshot.val() || {};
                filterAndRenderDrinks();
                loadingIndicator.classList.add('hidden');
            });
        }

        // --- Rendering Functions ---
        function renderCategories() {
            categoriesContainer.innerHTML = '';
            if (Object.keys(allCategories).length === 0) {
                 const defaultCat = { name: UNCATEGORIZED_NAME };
                 allCategories[UNCATEGORIZED_ID] = defaultCat;
                 set(child(dbRef, `barOrganizerData/categories/${UNCATEGORIZED_ID}`), defaultCat);
            }

            Object.entries(allCategories).forEach(([id, category]) => {
                const isActive = id === selectedCategoryId;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `p-2.5 mb-1.5 rounded-lg cursor-pointer hover:bg-indigo-100 dark:hover:bg-gray-700 transition-colors duration-150 ease-in-out flex justify-between items-center text-sm ${isActive ? 'category-active bg-indigo-600 dark:bg-indigo-500 text-white' : 'bg-gray-50 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300'}`;
                categoryDiv.innerHTML = `
                    <span class="font-medium">${category.name}</span>
                    ${editModeActive && id !== UNCATEGORIZED_ID ? `
                        <div class="space-x-2">
                            <button data-id="${id}" class="edit-category-btn text-yellow-500 dark:text-yellow-400 hover:text-yellow-400 dark:hover:text-yellow-300 p-1"><i class="fas fa-edit"></i></button>
                            ${Object.keys(allCategories).length > 1 ? `<button data-id="${id}" class="delete-category-btn text-red-500 dark:text-red-400 hover:text-red-400 dark:hover:text-red-300 p-1"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    ` : ''}
                     ${editModeActive && id === UNCATEGORIZED_ID && Object.keys(allCategories).length <=1 ? `
                        <div class="space-x-2">
                            <button data-id="${id}" class="edit-category-btn text-yellow-500 dark:text-yellow-400 hover:text-yellow-400 dark:hover:text-yellow-300 p-1"><i class="fas fa-edit"></i></button>
                        </div>
                    ` : ''}
                `;
                categoryDiv.addEventListener('click', (e) => {
                    if (e.target.closest('.edit-category-btn') || e.target.closest('.delete-category-btn')) return;
                    selectedCategoryId = id;
                    renderCategories(); 
                    filterAndRenderDrinks();
                    if (window.innerWidth < 768) { // Close sidebar on mobile after selection
                        toggleSidebar();
                    }
                });
                categoriesContainer.appendChild(categoryDiv);
            });

            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {e.stopPropagation(); handleEditCategory(btn.dataset.id);});
            });
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {e.stopPropagation(); handleDeleteCategory(btn.dataset.id);});
            });
        }

        function filterAndRenderDrinks() {
            if (!selectedCategoryId && Object.keys(allCategories).length > 0) {
                selectedCategoryId = Object.keys(allCategories)[0];
            } else if (Object.keys(allCategories).length === 0) {
                 selectedCategoryId = UNCATEGORIZED_ID;
            }

            const currentCategoryName = allCategories[selectedCategoryId]?.name || "Alle Drinks";
            categoryTitle.textContent = currentCategoryName;
            drinksContainer.innerHTML = '';
            noDrinksMessage.classList.add('hidden');

            const searchTerms = currentSearchQuery.split(',')
                .map(term => term.trim().toLowerCase())
                .filter(term => term.length > 0);

            const drinksToDisplay = Object.entries(allDrinks).filter(([id, drink]) => {
                const matchesCategory = drink.categoryId === selectedCategoryId || (selectedCategoryId === 'all' && currentFilterType === 'Alles');
                const matchesType = currentFilterType === "Alles" || drink.type === currentFilterType;
                
                let matchesSearch = true;
                if (searchTerms.length > 0) {
                    matchesSearch = searchTerms.every(term => {
                        const nameMatchesTerm = drink.name.toLowerCase().includes(term);
                        const ingredientItems = (drink.ingredients || []).map(ing => ing.item.toLowerCase());
                        const ingredientMatchesTerm = ingredientItems.some(ingItem => ingItem.includes(term));
                        return nameMatchesTerm || ingredientMatchesTerm;
                    });
                }

                let categoryCondition = true;
                if (selectedCategoryId && selectedCategoryId !== 'all') {
                    categoryCondition = drink.categoryId === selectedCategoryId;
                    if (!allCategories[drink.categoryId] && drink.categoryId !== UNCATEGORIZED_ID) {
                         categoryCondition = selectedCategoryId === UNCATEGORIZED_ID;
                    }
                }
                return categoryCondition && matchesType && matchesSearch;
            });

            if (drinksToDisplay.length === 0) {
                noDrinksMessage.classList.remove('hidden');
                noDrinksMessage.textContent = `Keine Drinks in "${currentCategoryName}" gefunden${currentSearchQuery ? ` f√ºr "${currentSearchQuery.split(',').join(', ')}"` : ''}.`;
                if (editModeActive && selectedCategoryId && selectedCategoryId !== 'all') {
                    addDrinkButton.classList.remove('hidden');
                } else {
                    addDrinkButton.classList.add('hidden');
                }
                return;
            }

            drinksToDisplay.forEach(([id, drink]) => {
                const drinkCard = document.createElement('div');
                drinkCard.className = 'bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hover:shadow-xl drink-card';
                drinkCard.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-xl sm:text-2xl font-bold text-indigo-600 dark:text-indigo-400">${drink.name} <span class="text-lg">${drink.symbols || ''}</span></h3>
                        <span class="text-xs sm:text-sm px-3 py-1 rounded-full font-semibold ${drink.type === 'Mocktail' ? 'bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100' : 'bg-red-100 text-red-700 dark:bg-red-700 dark:text-red-100'}">${drink.type}</span>
                    </div>
                    <div class="mb-3">
                        <h4 class="font-semibold text-indigo-500 dark:text-indigo-300 mb-1 text-sm">Zutaten:</h4>
                        <ul class="list-disc list-inside text-gray-600 dark:text-gray-300 space-y-0.5 text-sm">
                            ${(drink.ingredients || []).map(ing => `<li>${ing.amount} ${ing.item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mb-1">
                        <h4 class="font-semibold text-indigo-500 dark:text-indigo-300 mb-1 text-sm">Rezept:</h4>
                        <p class="text-gray-500 dark:text-gray-400 text-sm">${drink.recipe}</p>
                    </div>
                    ${editModeActive ? `
                        <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2">
                            <button data-id="${id}" class="edit-drink-btn text-yellow-600 dark:text-yellow-400 hover:text-yellow-500 dark:hover:text-yellow-300 px-3 py-1.5 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-xs"><i class="fas fa-edit mr-1"></i> Bearbeiten</button>
                            <button data-id="${id}" class="delete-drink-btn text-red-600 dark:text-red-400 hover:text-red-500 dark:hover:text-red-300 px-3 py-1.5 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-xs"><i class="fas fa-trash mr-1"></i> L√∂schen</button>
                        </div>
                    ` : ''}
                `;
                drinksContainer.appendChild(drinkCard);
            });

            document.querySelectorAll('.edit-drink-btn').forEach(btn => {
                btn.addEventListener('click', () => handleEditDrink(btn.dataset.id));
            });
            document.querySelectorAll('.delete-drink-btn').forEach(btn => {
                btn.addEventListener('click', () => handleDeleteDrink(btn.dataset.id));
            });

            if (editModeActive && selectedCategoryId && selectedCategoryId !== 'all') {
                 addDrinkButton.classList.remove('hidden');
            } else {
                 addDrinkButton.classList.add('hidden');
            }
        }

        // --- Edit Mode --- (Button is now in settings modal)
        modalEditModeButton.addEventListener('click', () => {
            if (editModeActive) {
                editModeActive = false;
                updateEditModeUI();
            } else {
                settingsModal.classList.add('hidden'); // Hide settings before showing key modal
                accessKeyInput.value = '';
                accessKeyError.textContent = '';
                accessKeyModal.classList.remove('hidden');
            }
        });

        document.getElementById('accessKeySubmit').addEventListener('click', async () => {
            const keyAttempt = accessKeyInput.value;
            const dbKeySnapshot = await get(child(dbRef, 'barOrganizerData/Key'));
            const correctKey = dbKeySnapshot.val();

            if (keyAttempt === correctKey) {
                editModeActive = true;
                updateEditModeUI();
                accessKeyModal.classList.add('hidden');
            } else {
                accessKeyError.textContent = 'Ung√ºltiger Schl√ºssel.';
            }
        });
        document.getElementById('accessKeyCancel').addEventListener('click', () => {
            accessKeyModal.classList.add('hidden');
            // Optionally re-open settings modal if desired, or let user click again
            // settingsModal.classList.remove('hidden');
        });


        function updateEditModeUI() {
            if (editModeActive) {
                modalEditModeButton.innerHTML = '<i class="fas fa-lock-open mr-2"></i> Bearbeitungsmodus Verlassen';
                modalEditModeButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-400');
                modalEditModeButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-400');
                modalEditModeStatusText.textContent = 'Aktiv';
                modalEditModeStatusText.className = 'font-semibold text-green-600 dark:text-green-400';
                
                headerEditModeStatus.textContent = 'Bearbeitungsmodus Aktiv';
                headerEditModeStatus.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200', 'hidden');
                headerEditModeStatus.classList.add('bg-yellow-400', 'text-yellow-800', 'dark:bg-yellow-500', 'dark:text-gray-900');

                addCategoryButton.classList.remove('hidden');
                if (selectedCategoryId && selectedCategoryId !== 'all') addDrinkButton.classList.remove('hidden');

            } else {
                modalEditModeButton.innerHTML = '<i class="fas fa-lock mr-2"></i> Bearbeitungsmodus Aktivieren';
                modalEditModeButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-400');
                modalEditModeButton.classList.add('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-400');
                modalEditModeStatusText.textContent = 'Inaktiv';
                modalEditModeStatusText.className = 'font-semibold text-red-600 dark:text-red-400';

                headerEditModeStatus.textContent = 'Ansichtsmodus';
                headerEditModeStatus.classList.add('hidden'); // Or style as 'view mode'
                headerEditModeStatus.classList.remove('bg-yellow-400', 'text-yellow-800', 'dark:bg-yellow-500', 'dark:text-gray-900');
                headerEditModeStatus.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-200');


                addCategoryButton.classList.add('hidden');
                addDrinkButton.classList.add('hidden');
            }
            renderCategories();
            filterAndRenderDrinks();
        }

        // --- Search and Filter ---
        function handleSearchInput(e) {
            currentSearchQuery = e.target.value; // No toLowerCase here, handled in filter
            // Sync both search inputs if needed, or treat them as one logical input
            if (e.target.id === 'searchInput') searchInputMobile.value = currentSearchQuery;
            if (e.target.id === 'searchInputMobile') searchInput.value = currentSearchQuery;
            filterAndRenderDrinks();
        }
        searchInput.addEventListener('input', handleSearchInput);
        searchInputMobile.addEventListener('input', handleSearchInput);


        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-indigo-600', 'dark:bg-indigo-500', 'text-white', 'ring-2', 'ring-indigo-400');
                    b.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-indigo-500', 'dark:hover:bg-indigo-600', 'hover:text-white');
                });
                btn.classList.add('bg-indigo-600', 'dark:bg-indigo-500', 'text-white', 'ring-2', 'ring-indigo-400');
                btn.classList.remove('text-gray-700', 'dark:text-gray-300');
                currentFilterType = btn.dataset.type;
                filterAndRenderDrinks();
            });
        });

        // --- Category CRUD ---
        addCategoryButton.addEventListener('click', () => openCategoryModal());

        function openCategoryModal(id = null) {
            categoryForm.reset();
            categoryIdInput.value = id || '';
            if (id && allCategories[id]) {
                categoryModalTitle.textContent = 'Kategorie Bearbeiten';
                document.getElementById('categoryName').value = allCategories[id].name;
            } else {
                categoryModalTitle.textContent = 'Neue Kategorie Erstellen';
            }
            categoryModal.classList.remove('hidden');
        }

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = categoryIdInput.value;
            const name = document.getElementById('categoryName').value.trim();
            if (!name) {
                showCustomAlert("Kategoriename darf nicht leer sein.");
                return;
            }

            const categoryData = { name };
            try {
                if (id) {
                    await update(child(dbRef, `barOrganizerData/categories/${id}`), categoryData);
                } else {
                    const newCategoryRef = push(child(dbRef, 'barOrganizerData/categories'));
                    await set(newCategoryRef, categoryData);
                }
                categoryModal.classList.add('hidden');
            } catch (error) {
                console.error("Fehler beim Speichern der Kategorie:", error);
                showCustomAlert("Fehler beim Speichern der Kategorie.");
            }
        });
        document.getElementById('categoryCancel').addEventListener('click', () => categoryModal.classList.add('hidden'));

        function handleEditCategory(id) {
            openCategoryModal(id);
        }

        async function handleDeleteCategory(id) {
            if (id === UNCATEGORIZED_ID) {
                showCustomAlert("Die 'Unkategorisiert' Kategorie kann nicht gel√∂scht werden.");
                return;
            }
            if (Object.keys(allCategories).length <= 1) {
                showCustomAlert("Die letzte Kategorie kann nicht gel√∂scht werden.");
                return;
            }

            showConfirmModal(`Sicher, dass du die Kategorie "${allCategories[id].name}" l√∂schen willst? Alle Drinks darin werden als "Unkategorisiert" markiert.`, async () => {
                try {
                    const updates = {};
                    Object.entries(allDrinks).forEach(([drinkId, drink]) => {
                        if (drink.categoryId === id) {
                            updates[`barOrganizerData/drinks/${drinkId}/categoryId`] = UNCATEGORIZED_ID;
                        }
                    });
                    if (Object.keys(updates).length > 0) {
                        await update(dbRef, updates);
                    }
                    await remove(child(dbRef, `barOrganizerData/categories/${id}`));

                    if (selectedCategoryId === id) {
                        selectedCategoryId = UNCATEGORIZED_ID;
                    }
                } catch (error) {
                    console.error("Fehler beim L√∂schen der Kategorie:", error);
                    showCustomAlert("Fehler beim L√∂schen der Kategorie.");
                }
            });
        }

        // --- Drink CRUD ---
        addDrinkButton.addEventListener('click', () => {
            if (selectedCategoryId && selectedCategoryId !== 'all' && allCategories[selectedCategoryId]) {
                openDrinkModal(null, selectedCategoryId);
            } else {
                 const firstValidCategory = Object.keys(allCategories).find(catId => catId !== UNCATEGORIZED_ID && catId !== 'all') || Object.keys(allCategories)[0];
                 if (firstValidCategory) {
                    openDrinkModal(null, firstValidCategory);
                 } else {
                    showCustomAlert("Bitte erstelle zuerst eine Kategorie (au√üer 'Unkategorisiert'), um einen Drink hinzuzuf√ºgen.");
                 }
            }
        });


        function populateCategorySelect(selectedDrinkCategoryId = null) {
            drinkCategorySelect.innerHTML = '';
            Object.entries(allCategories).forEach(([id, category]) => {
                if (id === UNCATEGORIZED_ID && (!selectedDrinkCategoryId || selectedDrinkCategoryId !== UNCATEGORIZED_ID)) return;
                const option = document.createElement('option');
                option.value = id;
                option.textContent = category.name;
                if (selectedDrinkCategoryId === id) {
                    option.selected = true;
                }
                drinkCategorySelect.appendChild(option);
            });
            if (!selectedDrinkCategoryId && selectedCategoryId && allCategories[selectedCategoryId] && selectedCategoryId !== 'all') {
                 drinkCategorySelect.value = selectedCategoryId;
            } else if (!selectedDrinkCategoryId && Object.keys(allCategories).length > 0) {
                const firstValidCategory = Object.keys(allCategories).find(catId => catId !== UNCATEGORIZED_ID && catId !== 'all') || Object.keys(allCategories)[0];
                if(firstValidCategory) drinkCategorySelect.value = firstValidCategory;
            }
        }

        function openDrinkModal(id = null, currentCatId = null) {
            drinkForm.reset();
            document.getElementById('ingredientsContainer').innerHTML = ''; 
            addIngredientField(); 

            drinkIdInput.value = id || '';
            let drinkCategoryIdForSelect = currentCatId || selectedCategoryId;

            if (id && allDrinks[id]) {
                drinkModalTitle.textContent = 'Drink Bearbeiten';
                const drink = allDrinks[id];
                document.getElementById('drinkName').value = drink.name;
                document.getElementById('drinkType').value = drink.type;
                document.getElementById('drinkSymbols').value = drink.symbols || '';
                document.getElementById('drinkRecipe').value = drink.recipe;
                drinkCategoryIdForSelect = drink.categoryId; 

                if (drink.ingredients && drink.ingredients.length > 0) {
                    document.getElementById('ingredientsContainer').innerHTML = ''; 
                    drink.ingredients.forEach(ing => addIngredientField(ing.item, ing.amount));
                }
            } else {
                drinkModalTitle.textContent = 'Neuen Drink Erstellen';
                if (selectedCategoryId && selectedCategoryId !== 'all' && allCategories[selectedCategoryId]) {
                    drinkCategoryIdForSelect = selectedCategoryId;
                } else if (Object.keys(allCategories).length > 0) {
                    drinkCategoryIdForSelect = Object.keys(allCategories).find(catId => catId !== UNCATEGORIZED_ID && catId !== 'all') || Object.keys(allCategories)[0];
                }
            }
            populateCategorySelect(drinkCategoryIdForSelect);
            drinkModal.classList.remove('hidden');
        }

        drinkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = drinkIdInput.value;
            const name = document.getElementById('drinkName').value.trim();
            const type = document.getElementById('drinkType').value;
            const categoryId = drinkCategorySelect.value;
            const symbols = document.getElementById('drinkSymbols').value.trim();
            const recipe = document.getElementById('drinkRecipe').value.trim();

            if (!name || !type || !categoryId || !recipe) {
                showCustomAlert("Bitte f√ºlle alle Pflichtfelder aus (Name, Typ, Kategorie, Rezept).");
                return;
            }

            const ingredients = [];
            document.querySelectorAll('.ingredient-field').forEach(field => {
                const item = field.querySelector('input[name="ingredientItem"]').value.trim();
                const amount = field.querySelector('input[name="ingredientAmount"]').value.trim();
                if (item && amount) {
                    ingredients.push({ item, amount });
                }
            });

            if (ingredients.length === 0) {
                showCustomAlert("Bitte f√ºge mindestens eine Zutat hinzu.");
                return;
            }

            const drinkData = { name, type, categoryId, symbols, recipe, ingredients };

            try {
                if (id) {
                    await update(child(dbRef, `barOrganizerData/drinks/${id}`), drinkData);
                } else {
                    const newDrinkRef = push(child(dbRef, 'barOrganizerData/drinks'));
                    await set(newDrinkRef, drinkData);
                }
                drinkModal.classList.add('hidden');
            } catch (error) {
                console.error("Fehler beim Speichern des Drinks:", error);
                showCustomAlert("Fehler beim Speichern des Drinks.");
            }
        });

        document.getElementById('drinkCancel').addEventListener('click', () => drinkModal.classList.add('hidden'));
        document.getElementById('addIngredientBtn').addEventListener('click', () => addIngredientField());

        function addIngredientField(item = '', amount = '') {
            const ingredientsContainer = document.getElementById('ingredientsContainer');
            const newField = document.createElement('div');
            newField.className = 'ingredient-field flex space-x-2 mb-2 items-center';
            newField.innerHTML = `
                <input type="text" name="ingredientItem" placeholder="Zutat" value="${item}" class="flex-grow bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm">
                <input type="text" name="ingredientAmount" placeholder="Menge" value="${amount}" class="w-1/3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm">
                <button type="button" class="remove-ingredient-btn text-red-500 dark:text-red-400 hover:text-red-400 dark:hover:text-red-300 p-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"><i class="fas fa-minus-circle"></i></button>
            `;
            ingredientsContainer.appendChild(newField);
            newField.querySelector('.remove-ingredient-btn').addEventListener('click', () => newField.remove());
        }

        function handleEditDrink(id) {
            openDrinkModal(id);
        }

        async function handleDeleteDrink(id) {
            showConfirmModal(`Sicher, dass du den Drink "${allDrinks[id].name}" l√∂schen willst?`, async () => {
                try {
                    await remove(child(dbRef, `barOrganizerData/drinks/${id}`));
                } catch (error) {
                    console.error("Fehler beim L√∂schen des Drinks:", error);
                    showCustomAlert("Fehler beim L√∂schen des Drinks.");
                }
            });
        }

        // --- Confirm Modal ---
        function showConfirmModal(text, callback) {
            confirmModalText.textContent = text;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        }
        document.getElementById('confirmYes').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
        });
        document.getElementById('confirmNo').addEventListener('click', () => {
            confirmModal.classList.add('hidden');
        });

        // --- Custom Alert Modal ---
        const customAlertCloseButton = document.getElementById('customAlertCloseBtn');
        function showCustomAlert(message) {
            customAlertText.textContent = message;
            customAlertModal.classList.remove('hidden');
        }
        customAlertCloseButton.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
        });


        // --- Initial Load ---
        async function main() {
            // Initialize theme first
            const initialTheme = localStorage.getItem('theme') || 'system';
            applyTheme(initialTheme);
            
            initializeSidebarState(); // Then sidebar
            
            await initializeDefaultData();
            loadData();
            updateEditModeUI();
            
            // Set default filter button active
            const defaultFilterBtn = document.querySelector('.filter-btn[data-type="Alles"]');
            if (defaultFilterBtn) {
                 defaultFilterBtn.classList.add('bg-indigo-600', 'dark:bg-indigo-500', 'text-white', 'ring-2', 'ring-indigo-400');
                 defaultFilterBtn.classList.remove('text-gray-700', 'dark:text-gray-300');
            }
        }

        main();

    </script>

</body>
</html>
